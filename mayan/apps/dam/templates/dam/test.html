{% extends "appearance/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}DAM Test Page{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-flask"></i>
                        DAM Test Interface
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Test page for DAM functionality. This page allows you to test AI analysis without UI integration.
                    </p>

                    <!-- Document Selection -->
                    <div class="form-group">
                        <label for="documentSelect">Select Document:</label>
                        <select class="form-control" id="documentSelect">
                            <option value="">Choose document...</option>
                            {% for doc in documents %}
                            <option value="{{ doc.id }}">{{ doc.label }} (ID: {{ doc.id }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-group mb-3">
                        <button class="btn btn-primary" onclick="startAnalysis()">
                            <i class="fas fa-play"></i>
                            Start AI Analysis
                        </button>
                        <button class="btn btn-info" onclick="checkStatus()">
                            <i class="fas fa-info"></i>
                            Check Status
                        </button>
                        <button class="btn btn-success" onclick="loadResults()">
                            <i class="fas fa-eye"></i>
                            Load Results
                        </button>
                    </div>

                    <!-- Results Area -->
                    <div id="results" class="mt-3" style="display: none;">
                        <h6>Analysis Results:</h6>
                        <div id="resultsContent"></div>
                    </div>

                    <!-- Debug Info -->
                    <div class="mt-4">
                        <h6>Debug Information:</h6>
                        <ul>
                            <li>Total documents: {{ documents|length }}</li>
                            <li>DAM API available: <span id="apiStatus">Checking...</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedDocumentId = null;

document.getElementById('documentSelect').addEventListener('change', function() {
    selectedDocumentId = this.value;
});

function startAnalysis() {
    if (!selectedDocumentId) {
        alert('Please select a document first');
        return;
    }

    showResults('Starting AI analysis...');

    $.ajax({
        url: '/api/dam/ai-analysis/analyze/',
        method: 'POST',
        data: { document_id: selectedDocumentId },
        success: function(response) {
            showResults('Analysis started successfully! Analysis ID: ' + response.analysis_id);
        },
        error: function(xhr) {
            showResults('Error starting analysis: ' + xhr.responseJSON?.error || xhr.statusText);
        }
    });
}

function checkStatus() {
    if (!selectedDocumentId) {
        alert('Please select a document first');
        return;
    }

    $.ajax({
        url: '/api/dam/analysis-status/',
        data: { document_id: selectedDocumentId },
        success: function(response) {
            let status = `Status: ${response.status}`;
            if (response.provider) status += ` | Provider: ${response.provider}`;
            if (response.completed_at) status += ` | Completed: ${new Date(response.completed_at).toLocaleString()}`;
            showResults(status);
        },
        error: function(xhr) {
            showResults('Error checking status: ' + xhr.statusText);
        }
    });
}

function loadResults() {
    if (!selectedDocumentId) {
        alert('Please select a document first');
        return;
    }

    $.ajax({
        url: '/api/dam/document-detail/',
        data: { document_id: selectedDocumentId },
        success: function(response) {
            $('#resultsContent').html(response.html);
            $('#results').show();
        },
        error: function(xhr) {
            showResults('Error loading results: ' + xhr.statusText);
        }
    });
}

function showResults(message) {
    $('#resultsContent').html('<div class="alert alert-info">' + message + '</div>');
    $('#results').show();
}

// Check API availability on load
$(document).ready(function() {
    $.ajax({
        url: '/api/dam/',
        timeout: 5000,
        success: function() {
            $('#apiStatus').html('<span class="text-success">✓ Available</span>');
        },
        error: function() {
            $('#apiStatus').html('<span class="text-danger">✗ Not available</span>');
        }
    });
});
</script>
{% endblock %}

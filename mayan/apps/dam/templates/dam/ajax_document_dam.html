{% load i18n %}
{% load static %}

<div id="dam-content">
    {% if ai_analysis %}
        <!-- AI Analysis Results -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-robot"></i>
                    {% trans "AI-Generated Metadata" %}
                </h6>
            </div>
            <div class="card-body">
                {% if ai_analysis.analysis_status == 'completed' %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{% trans "Description" %}</h6>
                            <p>{{ ai_analysis.ai_description|default:"No description available" }}</p>

                            <h6 class="mt-3">{% trans "Tags" %}</h6>
                            <div class="mb-2">
                                {% for tag in ai_analysis.ai_tags %}
                                    <span class="badge badge-primary mr-1">{{ tag }}</span>
                                {% empty %}
                                    <span class="text-muted">{% trans "No tags available" %}</span>
                                {% endfor %}
                            </div>

                            <h6 class="mt-3">{% trans "Categories" %}</h6>
                            <div class="mb-2">
                                {% for category in ai_analysis.categories %}
                                    <span class="badge badge-info mr-1">{{ category }}</span>
                                {% empty %}
                                    <span class="text-muted">{% trans "No categories available" %}</span>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6>{% trans "People & Entities" %}</h6>
                            <div class="mb-2">
                                {% for person in ai_analysis.people %}
                                    <span class="badge badge-success mr-1">{{ person }}</span>
                                {% empty %}
                                    <span class="text-muted">{% trans "No people identified" %}</span>
                                {% endfor %}
                            </div>

                            <h6 class="mt-3">{% trans "Locations" %}</h6>
                            <div class="mb-2">
                                {% for location in ai_analysis.locations %}
                                    <span class="badge badge-warning mr-1">{{ location }}</span>
                                {% empty %}
                                    <span class="text-muted">{% trans "No locations identified" %}</span>
                                {% endfor %}
                            </div>

                            {% if ai_analysis.language %}
                            <h6 class="mt-3">{% trans "Language" %}</h6>
                            <p>{{ ai_analysis.language }}</p>
                            {% endif %}

                            {% if ai_analysis.alt_text %}
                            <h6 class="mt-3">{% trans "Alt Text" %}</h6>
                            <p>{{ ai_analysis.alt_text }}</p>
                            {% endif %}
                        </div>
                    </div>

                    {% if ai_analysis.copyright_notice or ai_analysis.usage_rights %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="border-top pt-3">{% trans "Rights & Copyright" %}</h6>
                            {% if ai_analysis.copyright_notice %}
                            <p><strong>{% trans "Copyright Notice" %}:</strong> {{ ai_analysis.copyright_notice }}</p>
                            {% endif %}

                            {% if ai_analysis.usage_rights %}
                            <p><strong>{% trans "Usage Rights" %}:</strong> {{ ai_analysis.usage_rights }}</p>
                            {% endif %}

                            {% if ai_analysis.rights_expiry %}
                            <p><strong>{% trans "Rights Expiry" %}:</strong> {{ ai_analysis.rights_expiry|date:"M j, Y" }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted">
                                {% trans "Analysis completed" %}: {{ ai_analysis.analysis_completed|date:"M j, Y g:i A" }}
                                {% if ai_analysis.ai_provider %}
                                    | {% trans "Provider" %}: {{ ai_analysis.ai_provider }}
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="mt-3">
                        <a href="#" class="btn btn-sm btn-outline-primary" onclick="reanalyzeDAM({{ document.id }})">
                            <i class="fas fa-sync"></i>
                            {% trans "Re-analyze with AI" %}
                        </a>
                        <a href="#" class="btn btn-sm btn-outline-secondary" onclick="editDAMMetadata({{ ai_analysis.id }})">
                            <i class="fas fa-edit"></i>
                            {% trans "Edit Metadata" %}
                        </a>
                    </div>

                {% elif ai_analysis.analysis_status == 'processing' %}
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>{% trans "AI analysis in progress. Please check back later." %}</p>
                    </div>

                {% elif ai_analysis.analysis_status == 'failed' %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        {% trans "AI analysis failed. Try re-analyzing the document." %}
                        <a href="#" class="btn btn-sm btn-danger ml-2" onclick="reanalyzeDAM({{ document.id }})">
                            <i class="fas fa-sync"></i>
                            {% trans "Retry" %}
                        </a>
                    </div>

                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-clock fa-2x mb-3"></i>
                        <p>{% trans "AI analysis not yet started." %}</p>
                        <a href="#" class="btn btn-primary" onclick="reanalyzeDAM({{ document.id }})">
                            <i class="fas fa-play"></i>
                            {% trans "Start AI Analysis" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

    {% else %}
        <!-- No AI analysis yet -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-robot"></i>
                    {% trans "Digital Asset Management" %}
                </h6>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-brain fa-3x mb-3 text-muted"></i>
                <p>{% trans "No AI analysis available for this document." %}</p>
                <a href="#" class="btn btn-primary" onclick="reanalyzeDAM({{ document.id }})">
                    <i class="fas fa-play"></i>
                    {% trans "Start AI Analysis" %}
                </a>
            </div>
        </div>
    {% endif %}
</div>

<script>
function reanalyzeDAM(documentId) {
    if (confirm('{% trans "Start AI analysis for this document?" %}')) {
        // Show loading
        $('#dam-content').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>{% trans "Starting analysis..." %}</p></div>');

        // Make API call with CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajax({
            url: '/api/dam/ai-analysis/analyze/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: { document_id: documentId },
            success: function(response) {
                // Reload the DAM content
                loadDAMContent(documentId);
            },
            error: function(xhr) {
                alert('{% trans "Error starting analysis:" %} ' + xhr.responseJSON.detail);
                loadDAMContent(documentId); // Reload on error
            }
        });
    }
}

function editDAMMetadata(analysisId) {
    // This would open an edit modal or redirect to edit page
    alert('{% trans "Edit functionality will be implemented in the next step" %}');
}

function loadDAMContent(documentId) {
    // Reload the DAM AJAX template
    $.ajax({
        url: '/api/dam/document-detail/',
        data: { document_id: documentId },
        success: function(response) {
            $('#dam-content').html(response.html);
        },
        error: function(xhr) {
            $('#dam-content').html('<div class="alert alert-danger">{% trans "Error loading DAM content" %}</div>');
        }
    });
}
</script>

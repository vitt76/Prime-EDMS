{% extends "appearance/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "DAM Asset Details" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <!-- Asset Preview -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-image"></i>
                        {% trans "Asset Preview" %}
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if latest_file %}
                        {% if latest_file.mimetype|slice:":5" == "image" %}
                            <img src="{% url 'documents:document_file_page_view' document_id=document.pk document_file_id=latest_file.pk page_number=1 %}"
                                 class="img-fluid rounded" style="max-height: 400px;"
                                 alt="{% trans 'Asset preview' %}">
                        {% else %}
                            <div class="text-muted">
                                <i class="fas fa-file fa-4x mb-3"></i>
                                <p>{% trans "Preview not available for this file type" %}</p>
                                <small class="text-muted">{{ latest_file.mimetype }}</small>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-muted">
                            <i class="fas fa-file fa-4x mb-3"></i>
                            <p>{% trans "No file available" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Asset Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Asset Information" %}
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">{% trans "Document" %}:</dt>
                        <dd class="col-sm-8">
                            <a href="{% url 'documents:document_preview' document_id=document.pk %}">{{ document.label }}</a>
                        </dd>

                        {% if latest_file %}
                        <dt class="col-sm-4">{% trans "File" %}:</dt>
                        <dd class="col-sm-8">{{ latest_file.filename }}</dd>

                        <dt class="col-sm-4">{% trans "Size" %}:</dt>
                        <dd class="col-sm-8">{{ latest_file.size|filesizeformat }}</dd>

                        <dt class="col-sm-4">{% trans "Type" %}:</dt>
                        <dd class="col-sm-8">{{ latest_file.mimetype }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">{% trans "Status" %}:</dt>
                        <dd class="col-sm-8">
                            {% if object.analysis_status == 'completed' %}
                                <span class="badge badge-success">{% trans "Completed" %}</span>
                            {% elif object.analysis_status == 'processing' %}
                                <span class="badge badge-warning">{% trans "Processing" %}</span>
                            {% elif object.analysis_status == 'failed' %}
                                <span class="badge badge-danger">{% trans "Failed" %}</span>
                            {% else %}
                                <span class="badge badge-secondary">{% trans "Pending" %}</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-cogs"></i>
                        {% trans "Actions" %}
                    </h6>
                </div>
                <div class="card-body">
                    {% if can_reanalyze %}
                        <a href="{% url 'dam:asset_reanalyze' ai_analysis_id=object.pk %}"
                           class="btn btn-primary btn-sm btn-block">
                            <i class="fas fa-sync"></i>
                            {% trans "Re-analyze with AI" %}
                        </a>
                    {% endif %}

                    {% if can_edit %}
                        <a href="{% url 'dam:asset_edit' ai_analysis_id=object.pk %}"
                           class="btn btn-secondary btn-sm btn-block mt-2">
                            <i class="fas fa-edit"></i>
                            {% trans "Edit Metadata" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- AI Metadata -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-robot"></i>
                        {% trans "AI-Generated Metadata" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if object.analysis_status == 'completed' %}
                        <div class="row">
                            <div class="col-md-6">
                                <h6>{% trans "Description" %}</h6>
                                <p>{{ object.ai_description|default:"No description available" }}</p>

                                <h6 class="mt-3">{% trans "Tags" %}</h6>
                                <div class="mb-2">
                                    {% for tag in formatted_tags %}
                                        <span class="badge badge-primary mr-1">{{ tag }}</span>
                                    {% empty %}
                                        <span class="text-muted">{% trans "No tags available" %}</span>
                                    {% endfor %}
                                </div>

                                <h6 class="mt-3">{% trans "Categories" %}</h6>
                                <div class="mb-2">
                                    {% for category in object.categories %}
                                        <span class="badge badge-info mr-1">{{ category }}</span>
                                    {% empty %}
                                        <span class="text-muted">{% trans "No categories available" %}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6>{% trans "People & Entities" %}</h6>
                                <div class="mb-2">
                                    {% for person in object.people %}
                                        <span class="badge badge-success mr-1">{{ person }}</span>
                                    {% empty %}
                                        <span class="text-muted">{% trans "No people identified" %}</span>
                                    {% endfor %}
                                </div>

                                <h6 class="mt-3">{% trans "Locations" %}</h6>
                                <div class="mb-2">
                                    {% for location in object.locations %}
                                        <span class="badge badge-warning mr-1">{{ location }}</span>
                                    {% empty %}
                                        <span class="text-muted">{% trans "No locations identified" %}</span>
                                    {% endfor %}
                                </div>

                                {% if object.language %}
                                <h6 class="mt-3">{% trans "Language" %}</h6>
                                <p>{{ object.language }}</p>
                                {% endif %}

                                {% if object.alt_text %}
                                <h6 class="mt-3">{% trans "Alt Text" %}</h6>
                                <p>{{ object.alt_text }}</p>
                                {% endif %}
                            </div>
                        </div>

                        {% if object.copyright_notice or object.usage_rights %}
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="border-top pt-3">{% trans "Rights & Copyright" %}</h6>
                                {% if object.copyright_notice %}
                                <p><strong>{% trans "Copyright Notice" %}:</strong> {{ object.copyright_notice }}</p>
                                {% endif %}

                                {% if object.usage_rights %}
                                <p><strong>{% trans "Usage Rights" %}:</strong> {{ object.usage_rights }}</p>
                                {% endif %}

                                {% if object.rights_expiry %}
                                <p><strong>{% trans "Rights Expiry" %}:</strong> {{ object.rights_expiry|date:"M j, Y" }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="row mt-3">
                            <div class="col-12">
                                <small class="text-muted">
                                    {% trans "Analysis completed" %}: {{ object.analysis_completed|date:"M j, Y g:i A" }}
                                    {% if object.ai_provider %}
                                        | {% trans "Provider" %}: {{ object.ai_provider }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                    {% elif object.analysis_status == 'processing' %}
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>{% trans "AI analysis in progress. Please check back later." %}</p>
                        </div>

                    {% elif object.analysis_status == 'failed' %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            {% trans "AI analysis failed. Try re-analyzing the document." %}
                        </div>

                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-clock fa-2x mb-3"></i>
                            <p>{% trans "AI analysis not yet started." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

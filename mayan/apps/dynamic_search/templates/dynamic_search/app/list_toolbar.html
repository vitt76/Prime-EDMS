{% load i18n %}

{# appearance_app_template_nocache #}

{% if not search_disable_list_filtering and search_model %}
    <div class="pull-left">
        <div class="btn-toolbar" role="toolbar">
            <form action="" id="search-form-filter" method="get" role="search">
                <div class="input-group">
                    {# Reset the paging on every filter update #}
                    {# Avoids invalid page errors when the current page nubmer is higher that the filter page count results #}
                    <input class="form-control" id="search-filter-page" name="page" type="hidden" value="1">
                    <input class="form-control" id="search-filter-input-terms" name="q" placeholder="{% trans 'List filter' %}" type="search" value="{{ filter_terms|default:'' }}">
                    <span class="glyphicon glyphicon-remove-circle" id="search-filter-button-clear"></span>
                </div>
            </form>
        </div>
    </div>
{% endif %}

<script>
    'use strict';

    jQuery(document).ready(function() {
        const $filterButtonClear = $('#search-filter-button-clear');
        const $filterInputTerms = $('#search-filter-input-terms');
        const $formFilter = $('#search-form-filter');

        // Enable the event handlers only if the filter is present.
        // Otherwise it means that the displayed objects does not support
        // searching.
        if ($filterInputTerms.length) {
            function updateFilterButtonClear () {
                const filterValue = $filterInputTerms.val().trim();
                if (filterValue) {
                    $filterButtonClear.show();
                } else {
                    $filterButtonClear.hide();
                }
            }

            updateFilterButtonClear();

            // Debouncing для оптимизации производительности поиска
            // Задержка перед отправкой запроса - снижает нагрузку на сервер
            let searchTimeout;
            const SEARCH_DEBOUNCE_MS = 400; // 400ms задержка
            
            // Обработчик ввода с debouncing
            $filterInputTerms.on('input', function () {
                const $this = $(this);
                const searchValue = $this.val().trim();
                
                // Обновляем кнопку очистки
                updateFilterButtonClear();
                
                // Очищаем предыдущий таймер
                clearTimeout(searchTimeout);
                
                // Если поле пустое, сразу очищаем результаты
                if (!searchValue) {
                    $formFilter.submit();
                    return;
                }
                
                // Устанавливаем новый таймер для отправки запроса
                searchTimeout = setTimeout(function() {
                    $formFilter.submit();
                }, SEARCH_DEBOUNCE_MS);
            });
            
            // Сохраняем старый keyup для обратной совместимости (только для кнопки очистки)
            $filterInputTerms.keyup(function () {
                updateFilterButtonClear();
            });

            $filterButtonClear.click(function(){
                // Очищаем таймер при ручной очистке
                clearTimeout(searchTimeout);
                $filterInputTerms.val('');
                $formFilter.submit();
            });
        }
    });
</script>

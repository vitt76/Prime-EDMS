{% extends "appearance/base.html" %}

{% load i18n static %}

{% block title %}{% trans "Получатели" %}{% endblock %}

{% block content %}
<div class="container-fluid" id="recipients-app">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-users text-primary"></i>
                        {% trans "Получатели публикаций" %}
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="clearfix" style="margin-bottom: 15px;">
                        <button id="btn-create-recipient" class="btn btn-success pull-right">
                            <i class="fa fa-plus"></i>
                            {% trans "Создать получателя" %}
                        </button>
                    </div>

                    <div id="recipient-alert" class="alert" style="display: none;"></div>

                    <div id="recipients-loading" class="text-center" style="display: none;">
                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                        <p>{% trans "Загрузка получателей..." %}</p>
                    </div>

                    <div id="recipients-empty" class="alert alert-info text-center" style="display: none;">
                        <i class="fa fa-info-circle"></i>
                        <p>{% trans "Пока нет получателей." %}</p>
                    </div>

                    <div class="table-responsive" id="recipients-table-wrapper" style="display: none;">
                        <table class="table table-striped" id="recipients-table">
                            <thead>
                                <tr>
                                    <th>{% trans "Имя" %}</th>
                                    <th>{% trans "Email" %}</th>
                                    <th>{% trans "Организация" %}</th>
                                    <th>{% trans "Язык" %}</th>
                                    <th class="text-right" style="width: 140px;">{% trans "Действия" %}</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recipientModal" tabindex="-1" role="dialog" aria-labelledby="recipientModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="recipientModalLabel">{% trans "Создание получателя" %}</h4>
            </div>
            <div class="modal-body">
                <form id="recipient-form">
                    <div class="form-group">
                        <label for="recipient-name">{% trans "Имя" %}</label>
                        <input type="text" class="form-control" id="recipient-name" maxlength="255">
                    </div>
                    <div class="form-group">
                        <label for="recipient-email">Email</label>
                        <input type="email" class="form-control" id="recipient-email" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-organization">{% trans "Организация" %}</label>
                        <input type="text" class="form-control" id="recipient-organization" maxlength="255">
                    </div>
                    <div class="form-group">
                        <label for="recipient-locale">{% trans "Язык (locale)" %}</label>
                        <input type="text" class="form-control" id="recipient-locale" maxlength="10" placeholder="ru, en, ...">
                    </div>
                </form>
                <div id="recipient-form-alert" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Отмена" %}</button>
                <button type="button" class="btn btn-primary" id="recipient-save-btn">{% trans "Сохранить" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const apiBase = '/api/v4/distribution/recipients/';
    let editingRecipientId = null;

    function showAlert(message, type='info') {
        const alertBox = $('#recipient-alert');
        if (!message) {
            alertBox.hide();
            return;
        }
        alertBox.removeClass('alert-info alert-success alert-danger alert-warning');
        alertBox.addClass('alert-' + type);
        alertBox.text(message).show();
    }

    function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
        return null;
    }

    function setLoading(value) {
        if (value) {
            $('#recipients-loading').show();
            $('#recipients-table-wrapper').hide();
            $('#recipients-empty').hide();
        } else {
            $('#recipients-loading').hide();
        }
    }

    function openModal(title, recipient) {
        $('#recipientModalLabel').text(title);
        $('#recipient-form-alert').hide().text('');
        if (recipient) {
            $('#recipient-name').val(recipient.name || '');
            $('#recipient-email').val(recipient.email || '');
            $('#recipient-organization').val(recipient.organization || '');
            $('#recipient-locale').val(recipient.locale || '');
        } else {
            $('#recipient-form')[0].reset();
        }
        $('#recipientModal').modal('show');
    }

    function closeModal() {
        $('#recipientModal').modal('hide');
        editingRecipientId = null;
    }

    function fetchRecipients() {
        setLoading(true);
        showAlert(null);
        fetch(apiBase, {
            credentials: 'include'
        }).then(response => {
            if (!response.ok) {
                throw new Error(response.statusText || 'Error');
            }
            return response.json();
        }).then(data => {
            renderRecipients(data.results || []);
        }).catch(error => {
            showAlert(error.message || '{% trans "Не удалось загрузить получателей" %}', 'danger');
            $('#recipients-table-wrapper').hide();
        }).finally(() => {
            setLoading(false);
        });
    }

    function renderRecipients(recipients) {
        const tbody = $('#recipients-table tbody');
        tbody.empty();
        if (!recipients.length) {
            $('#recipients-empty').show();
            $('#recipients-table-wrapper').hide();
            return;
        }
        $('#recipients-empty').hide();
        $('#recipients-table-wrapper').show();

        recipients.forEach(recipient => {
            const row = $('<tr></tr>');
            row.append($('<td></td>').text(recipient.name || '—'));
            row.append($('<td></td>').text(recipient.email));
            row.append($('<td></td>').text(recipient.organization || '—'));
            row.append($('<td></td>').text(recipient.locale || '—'));

            const actionsTd = $('<td class="text-right"></td>');
            const editBtn = $('<button class="btn btn-xs btn-primary" title="{% trans "Редактировать" %}"><i class="fa fa-pencil"></i></button>');
            editBtn.click(() => editRecipient(recipient));

            const deleteBtn = $('<button class="btn btn-xs btn-danger" title="{% trans "Удалить" %}"><i class="fa fa-trash"></i></button>');
            deleteBtn.click(() => deleteRecipient(recipient));

            actionsTd.append(editBtn).append(' ').append(deleteBtn);
            row.append(actionsTd);
            tbody.append(row);
        });
    }

    function saveRecipient() {
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            $('#recipient-form-alert').text('{% trans "CSRF токен не найден. Обновите страницу." %}').show();
            return;
        }

        const payload = {
            name: $('#recipient-name').val(),
            email: $('#recipient-email').val(),
            organization: $('#recipient-organization').val(),
            locale: $('#recipient-locale').val()
        };

        if (!payload.email) {
            $('#recipient-form-alert').text('{% trans "Укажите email." %}').show();
            return;
        }

        const isEdit = Boolean(editingRecipientId);
        const url = isEdit ? apiBase + editingRecipientId + '/' : apiBase;
        const method = isEdit ? 'PATCH' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'include',
            body: JSON.stringify(payload)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    let message = '';
                    if (data.detail) {
                        message = data.detail;
                    } else if (typeof data === 'object') {
                        message = Object.values(data).flat().join(' ');
                    } else {
                        message = response.statusText;
                    }
                    throw new Error(message);
                });
            }
            return response.json();
        }).then(() => {
            closeModal();
            showAlert(isEdit ? '{% trans "Получатель обновлён" %}' : '{% trans "Получатель создан" %}', 'success');
            fetchRecipients();
        }).catch(error => {
            $('#recipient-form-alert').text(error.message || '{% trans "Не удалось сохранить" %}').show();
        });
    }

    function editRecipient(recipient) {
        editingRecipientId = recipient.id;
        openModal('{% trans "Редактирование получателя" %}', recipient);
    }

    function deleteRecipient(recipient) {
        if (!confirm('{% trans "Удалить получателя?" %}')) {
            return;
        }
        const csrfToken = getCookie('csrftoken');
        fetch(apiBase + recipient.id + '/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken || '',
                'Accept': 'application/json'
            },
            credentials: 'include'
        }).then(response => {
            if (response.ok || response.status === 204) {
                showAlert('{% trans "Получатель удалён" %}', 'success');
                fetchRecipients();
            } else {
                return response.json().then(data => {
                    const message = data.detail || JSON.stringify(data);
                    throw new Error(message);
                });
            }
        }).catch(error => {
            showAlert(error.message || '{% trans "Не удалось удалить" %}', 'danger');
        });
    }

    $('#btn-create-recipient').click(function() {
        editingRecipientId = null;
        openModal('{% trans "Создание получателя" %}');
    });

    $('#recipient-save-btn').click(function() {
        saveRecipient();
    });

    $('#recipientModal').on('hidden.bs.modal', function() {
        editingRecipientId = null;
        $('#recipient-form')[0].reset();
        $('#recipient-form-alert').hide().text('');
    });

    fetchRecipients();
})();
</script>
{% endblock %}

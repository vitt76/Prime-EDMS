{% extends "appearance/base.html" %}

{% load i18n static %}

{% block title %}{% trans "Управление ссылками" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-link text-primary"></i>
                        {% trans "Ссылки для скачивания" %}
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="row m-b-15">
                        <div class="col-md-12">
                            {% if current_publication %}
                                <div class="alert alert-info">
                                    <strong>{% trans "Публикация:" %}</strong> {{ current_publication.title }}
                                    <br>
                                    <small class="text-muted">{% trans "Для создания новых ссылок перейдите в детали публикации" %}</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if share_links %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>{% trans "Публикация / Рендишен" %}</th>
                                        <th>{% trans "Ссылка" %}</th>
                                        <th>{% trans "Создана" %}</th>
                                        <th>{% trans "Истекает" %}</th>
                                        <th>{% trans "Скачиваний" %}</th>
                                        <th>{% trans "Статус" %}</th>
                                        <th>{% trans "Действия" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for link in share_links %}
                                        <tr>
                                            <td>
                                                <strong>{{ link.rendition.publication_item.publication.title }}</strong><br>
                                                <small class="text-muted">{{ link.rendition.preset.name }} ({{ link.rendition.preset.format|upper }})</small>
                                            </td>
                                            <td>
                                                <code>{{ link.token }}</code>
                                                <button class="btn btn-xs btn-default" onclick="copyToClipboard('{{ link.token }}')">
                                                    <i class="fa fa-copy"></i>
                                                </button>
                                            </td>
                                            <td>{{ link.created|date:"d.m.Y H:i" }}</td>
                                            <td>
                                                {% if link.expires_at %}
                                                    {{ link.expires_at|date:"d.m.Y H:i" }}
                                                {% else %}
                                                    {% trans "Бессрочно" %}
                                                {% endif %}
                                            </td>
                                            <td>{{ link.downloads_count }} / {% if link.max_downloads %}{{ link.max_downloads }}{% else %}∞{% endif %}</td>
                                            <td>
                                                {% if link.is_valid %}
                                                    <span class="label label-success">{% trans "Активна" %}</span>
                                                {% else %}
                                                    <span class="label label-danger">{% trans "Истекла" %}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="http://localhost/{{ link.token }}/" target="_blank" class="btn btn-xs btn-primary" title="{% trans "Открыть файл" %}">
                                                    <i class="fa fa-external-link"></i>
                                                </a>
                                                <button type="button" class="btn btn-xs btn-warning" title="{% trans "Редактировать" %}" onclick="editShareLink({{ link.id }})">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-xs btn-danger" title="{% trans "Удалить" %}" onclick="deleteShareLink({{ link.id }})">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i>
                            {% trans "У вас пока нет ссылок для скачивания." %}
                        </div>
                    {% endif %}

                    <div class="form-group">
                        <a href="{% url 'distribution:publication_list' %}" class="btn btn-default">
                            <i class="fa fa-arrow-left"></i>
                            {% trans "Вернуться к публикациям" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareLinkModal" tabindex="-1" role="dialog" aria-labelledby="shareLinkModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="shareLinkModalLabel">{% trans "Редактирование ссылки" %}</h4>
            </div>
            <div class="modal-body">
                <form id="share-link-form" class="form-horizontal">
                    <div class="form-group">
                        <label for="share-link-publication" class="col-sm-3 control-label">{% trans "Публикация" %}</label>
                        <div class="col-sm-9">
                            <select class="form-control" id="share-link-publication" onchange="filterEditRenditions()">
                                <option value="">{% trans "Выберите публикацию" %}</option>
                                {% for publication in publications %}
                                <option value="{{ publication.pk }}">{{ publication.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="share-link-rendition" class="col-sm-3 control-label">{% trans "Рендишен" %}</label>
                        <div class="col-sm-9">
                            <select class="form-control" id="share-link-rendition" required>
                                <option value="">{% trans "Сначала выберите публикацию" %}</option>
                                {% for rendition in renditions %}
                                <option value="{{ rendition.pk }}"
                                        data-publication="{{ rendition.publication_item.publication.pk }}">
                                    {{ rendition.publication_item.publication.title }} - {{ rendition.preset.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <span class="help-block">{% trans "Выберите рендишен для ссылки." %}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="share-link-expires-at" class="col-sm-3 control-label">{% trans "Истекает" %}</label>
                        <div class="col-sm-9">
                            <input type="datetime-local" class="form-control" id="share-link-expires-at">
                            <small class="help-block">{% trans "Оставьте пустым для бессрочной ссылки" %}</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="share-link-max-downloads" class="col-sm-3 control-label">{% trans "Максимум скачиваний" %}</label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="share-link-max-downloads" min="0">
                            <small class="help-block">{% trans "Оставьте пустым для неограниченного количества" %}</small>
                        </div>
                    </div>
                </form>
                <div id="share-link-form-alert" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Отмена" %}</button>
                <button type="button" class="btn btn-primary" id="share-link-save-btn">{% trans "Сохранить" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        console.log('Copied to clipboard: ' + text);
    });
}

let editingShareLinkId = null;

function editShareLink(linkId) {
    editingShareLinkId = linkId;
    console.log('Editing share link:', linkId);

    // Get share link data
    fetch(`/api/v4/distribution/share_links/${linkId}/`, {
        credentials: 'include'
    }).then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('Share link не найден или у вас нет доступа к нему');
            } else if (response.status === 403) {
                throw new Error('У вас нет доступа к этому share link');
            } else {
                throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
            }
        }
        return response.json();
    }).then(data => {
        console.log('Share link data:', data);
        // Populate form fields
        // Find the rendition in the template data to get publication info
        const renditions = Array.from(document.querySelectorAll('#share-link-rendition option'));
        const currentRenditionOption = renditions.find(option => option.value == data.rendition);

        if (currentRenditionOption) {
            const publicationId = currentRenditionOption.getAttribute('data-publication');
            document.getElementById('share-link-publication').value = publicationId || '';
            document.getElementById('share-link-rendition').value = data.rendition || '';
        } else {
            console.warn('Rendition not found in template options:', data.rendition);
            document.getElementById('share-link-rendition').value = data.rendition || '';
        }

        document.getElementById('share-link-expires-at').value = data.expires_at ?
            new Date(data.expires_at).toISOString().slice(0, 16) : '';
        document.getElementById('share-link-max-downloads').value = data.max_downloads || '';

        // Apply filtering for renditions
        filterEditRenditions();

        // Show modal
        $('#shareLinkModal').modal('show');
    }).catch(error => {
        alert('Ошибка загрузки данных ссылки: ' + error.message);
    });
}

function deleteShareLink(linkId) {
    if (!confirm('{% trans "Удалить эту ссылку?" %}')) {
        return;
    }

    const csrfToken = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1];
    fetch(`/api/v4/distribution/share_links/${linkId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken || '',
            'Accept': 'application/json'
        },
        credentials: 'include'
    }).then(response => {
        if (response.ok || response.status === 204) {
            location.reload();
        } else {
            return response.json().then(data => {
                const message = data.detail || JSON.stringify(data);
                throw new Error(message);
            });
        }
    }).catch(error => {
        alert(error.message || '{% trans "Не удалось удалить ссылку" %}');
    });
}

function filterEditRenditions() {
    const publicationId = document.getElementById('share-link-publication').value;
    const renditionSelect = document.getElementById('share-link-rendition');
    const options = renditionSelect.querySelectorAll('option');

    // Показываем/скрываем опции рендишенов
    options.forEach(option => {
        if (option.value === '') {
            // Оставляем опцию "Сначала выберите публикацию"
            option.style.display = publicationId ? 'none' : 'block';
            return;
        }

        const optionPublicationId = option.getAttribute('data-publication');
        if (publicationId && optionPublicationId === publicationId) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });

    // Сбрасываем выбор рендишена при смене публикации
    if (!renditionSelect.querySelector('option[style*="block"]:checked')) {
        renditionSelect.value = '';
    }
}

function saveShareLink() {
    console.log('Saving share link:', editingShareLinkId);

    const csrfToken = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1];
    if (!csrfToken) {
        showShareLinkAlert('{% trans "CSRF токен не найден. Обновите страницу." %}', 'danger');
        return;
    }

    const renditionId = document.getElementById('share-link-rendition').value;
    if (!renditionId) {
        showShareLinkAlert('{% trans "Выберите рендишен" %}', 'danger');
        return;
    }

    const payload = {
        rendition: parseInt(renditionId),
        expires_at: document.getElementById('share-link-expires-at').value || null,
        max_downloads: document.getElementById('share-link-max-downloads').value ?
            parseInt(document.getElementById('share-link-max-downloads').value) : null
    };

    console.log('Sending payload:', payload);
    console.log('URL:', `/api/v4/distribution/share_links/${editingShareLinkId}/`);

    fetch(`/api/v4/distribution/share_links/${editingShareLinkId}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'include',
        body: JSON.stringify(payload)
    }).then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                let message = '';
                if (data.detail) {
                    message = data.detail;
                } else if (typeof data === 'object') {
                    message = Object.values(data).flat().join(' ');
                } else {
                    message = response.statusText;
                }
                throw new Error(message);
            });
        }
        return response.json();
    }).then(() => {
        $('#shareLinkModal').modal('hide');
        location.reload();
    }).catch(error => {
        showShareLinkAlert(error.message || '{% trans "Не удалось сохранить" %}', 'danger');
    });
}

function showShareLinkAlert(message, type = 'info') {
    const alertBox = document.getElementById('share-link-form-alert');
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.style.display = 'block';
}

// Bind save button handler when modal is shown
$('#shareLinkModal').on('shown.bs.modal', function() {
    const saveBtn = document.getElementById('share-link-save-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveShareLink);
        console.log('Save button handler bound');
    } else {
        console.error('Save button not found');
    }
});

$('#shareLinkModal').on('hidden.bs.modal', function() {
    editingShareLinkId = null;
    document.getElementById('share-link-form').reset();
    document.getElementById('share-link-form-alert').style.display = 'none';

    // Remove the event listener to prevent multiple bindings
    const saveBtn = document.getElementById('share-link-save-btn');
    if (saveBtn) {
        saveBtn.removeEventListener('click', saveShareLink);
    }
});

jQuery(document).ready(function() {
    // Hide labels and help blocks only outside of modals
    $('.help-block').not('.modal .help-block').hide();
    $('label').not('.modal label').hide();
});
</script>
{% endblock %}


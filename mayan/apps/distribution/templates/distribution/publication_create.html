{% extends "appearance/base.html" %}

{% load i18n static %}

{% block title %}{% trans "Создание публикации" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-plus text-primary"></i>
                        {% trans "Создание новой публикации" %}
                    </h3>
                </div>
                <div class="panel-body">
                    <form id="publication-form">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                        <div class="form-group">
                            <label for="title">{% trans "Название публикации" %} *</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>

                        <div class="form-group">
                            <label for="description">{% trans "Описание" %}</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            <small class="form-text text-muted">
                                {% trans "Необязательное описание публикации для получателей" %}
                            </small>
                        </div>

                        {% if document_id %}
                        <div class="form-group">
                            <label>{% trans "Документы для добавления" %}</label>
                            <div class="alert alert-info">
                                <i class="fa fa-info-circle"></i>
                                {% trans "После создания публикации будет автоматически добавлен документ #" %}{{ document_id }}
                            </div>
                        </div>
                        {% endif %}

                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i>
                            {% trans "После создания публикации вы сможете добавить в нее документы и настроить получателей." %}
                        </div>

                        <div id="form-messages"></div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="fa fa-save"></i>
                                {% trans "Создать публикацию" %}
                            </button>
                            <button type="button" class="btn btn-default" id="cancel-btn">
                                {% trans "Отмена" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('#publication-form').submit(function(e) {
        e.preventDefault();

        var submitBtn = $('#submit-btn');
        var originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {% trans "Создание..." %}');

        var formData = {
            title: $('#title').val(),
            description: $('#description').val()
        };

        {% if document_id %}
        // If we have a document_id, this is from document context
        formData.document_id = {{ document_id }};
        {% endif %}

        $.ajax({
            url: '/api/v4/distribution/publications/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(data) {
                $('#form-messages').html(
                    '<div class="alert alert-success">' +
                    '<i class="fa fa-check"></i> {% trans "Публикация создана успешно!" %}' +
                    '</div>'
                );

                {% if document_id %}
                // If we came from a document, add it to the publication
                addDocumentToPublication(data.id, {{ document_id }});
                {% else %}
                // Redirect to publications list
                setTimeout(function() {
                    window.location.hash = '#/distribution/publications/';
                }, 1500);
                {% endif %}
            },
            error: function(xhr, status, error) {
                submitBtn.prop('disabled', false).html(originalText);

                var errorMsg = '{% trans "Ошибка создания публикации" %}';
                if (xhr.responseJSON && xhr.responseJSON.detail) {
                    errorMsg += ': ' + xhr.responseJSON.detail;
                }

                $('#form-messages').html(
                    '<div class="alert alert-danger">' +
                    '<i class="fa fa-exclamation-triangle"></i> ' + errorMsg +
                    '</div>'
                );
            }
        });
    });

    $('#cancel-btn').click(function() {
        window.location.hash = '#/distribution/publications/';
    });
});

function addDocumentToPublication(publicationId, documentId) {
    // First, get document files
    $.ajax({
        url: '/api/v4/documents/documents/' + documentId + '/files/',
        method: 'GET',
        success: function(filesData) {
            if (filesData.results && filesData.results.length > 0) {
                // Add the first file to publication
                var fileId = filesData.results[0].id;
                $.ajax({
                    url: '/api/v4/distribution/publications/' + publicationId + '/items/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        document_file_id: fileId
                    }),
                    headers: {
                        'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function() {
                        $('#form-messages').append(
                            '<div class="alert alert-success">' +
                            '<i class="fa fa-check"></i> {% trans "Документ добавлен в публикацию!" %}' +
                            '</div>'
                        );

                        setTimeout(function() {
                            window.location.hash = '#/distribution/publications/';
                        }, 2000);
                    },
                    error: function() {
                        $('#form-messages').append(
                            '<div class="alert alert-warning">' +
                            '<i class="fa fa-exclamation-triangle"></i> {% trans "Публикация создана, но не удалось добавить документ." %}' +
                            '</div>'
                        );

                        setTimeout(function() {
                            window.location.hash = '#/distribution/publications/';
                        }, 3000);
                    }
                });
            } else {
                $('#form-messages').append(
                    '<div class="alert alert-warning">' +
                    '<i class="fa fa-exclamation-triangle"></i> {% trans "Публикация создана, но документ не найден." %}' +
                    '</div>'
                );

                setTimeout(function() {
                    window.location.hash = '#/distribution/publications/';
                }, 3000);
            }
        },
        error: function() {
            $('#form-messages').append(
                '<div class="alert alert-warning">' +
                '<i class="fa fa-exclamation-triangle"></i> {% trans "Публикация создана, но не удалось добавить документ." %}' +
                '</div>'
            );

            setTimeout(function() {
                window.location.hash = '#/distribution/publications/';
            }, 3000);
        }
    });
}
</script>
{% endblock %}

{% extends "appearance/base.html" %}

{% load i18n static %}

{% block title %}{% trans "Мои публикации" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-list text-primary"></i>
                        {% trans "Мои публикации" %}
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-12">
                            <button id="create-publication-btn" class="btn btn-primary pull-right">
                                <i class="fa fa-plus"></i>
                                {% trans "Создать публикацию" %}
                            </button>
                        </div>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loading-indicator" class="text-center" style="display: none;">
                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                        {% trans "Загрузка..." %}
                    </div>

                    <!-- Publications table -->
                    <div id="publications-container">
                        <div class="alert alert-info text-center">
                            <i class="fa fa-info-circle fa-3x"></i>
                            <h4>{% trans "Загрузка публикаций..." %}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    loadPublications();

    $('#create-publication-btn').click(function() {
        // In SPA context, navigate to create page
        window.location.hash = '#/distribution/publications/create/';
    });
});

function loadPublications() {
    $('#loading-indicator').show();

    $.ajax({
        url: '/api/v4/distribution/publications/',
        method: 'GET',
        headers: {
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(data) {
            $('#loading-indicator').hide();
            renderPublications(data.results || []);
        },
        error: function(xhr, status, error) {
            $('#loading-indicator').hide();
            $('#publications-container').html(
                '<div class="alert alert-danger">' +
                '<h4>{% trans "Ошибка загрузки" %}</h4>' +
                '<p>' + error + '</p>' +
                '</div>'
            );
        }
    });
}

function renderPublications(publications) {
    if (publications.length === 0) {
        $('#publications-container').html(
            '<div class="alert alert-info text-center">' +
            '<i class="fa fa-info-circle fa-3x"></i>' +
            '<h4>{% trans "У вас пока нет публикаций" %}</h4>' +
            '<p>{% trans "Создайте свою первую публикацию, чтобы начать делиться материалами." %}</p>' +
            '<button id="create-first-publication-btn" class="btn btn-primary btn-lg">' +
            '<i class="fa fa-plus"></i> {% trans "Создать первую публикацию" %}' +
            '</button>' +
            '</div>'
        );

        $('#create-first-publication-btn').click(function() {
            window.location.hash = '#/distribution/publications/create/';
        });

        return;
    }

    var html = '<div class="table-responsive">' +
        '<table class="table table-striped">' +
        '<thead>' +
        '<tr>' +
        '<th>{% trans "Название" %}</th>' +
        '<th>{% trans "Описание" %}</th>' +
        '<th>{% trans "Документов" %}</th>' +
        '<th>{% trans "Создано" %}</th>' +
        '<th>{% trans "Действия" %}</th>' +
        '</tr>' +
        '</thead>' +
        '<tbody>';

    publications.forEach(function(publication) {
        html += '<tr>' +
            '<td><strong>' + (publication.title || '—') + '</strong></td>' +
            '<td>' + (publication.description ? publication.description.substring(0, 50) + (publication.description.length > 50 ? '...' : '') : '—') + '</td>' +
            '<td>' + (publication.items_count || 0) + '</td>' +
            '<td>' + new Date(publication.created).toLocaleDateString() + '</td>' +
            '<td>' +
            '<div class="btn-group">' +
            '<button class="btn btn-xs btn-primary" onclick="viewPublication(' + publication.id + ')">' +
            '<i class="fa fa-eye"></i>' +
            '</button>' +
            '<button class="btn btn-xs btn-warning" onclick="manageLinks(' + publication.id + ')" title="{% trans "Управление ссылками" %}">' +
            '<i class="fa fa-link"></i>' +
            '</button>' +
            '</div>' +
            '</td>' +
            '</tr>';
    });

    html += '</tbody></table></div>';
    $('#publications-container').html(html);
}

function viewPublication(id) {
    window.location.hash = '#/distribution/publications/' + id + '/';
}

function manageLinks(id) {
    window.location.hash = '#/distribution/share-links/?publication=' + id;
}
</script>
{% endblock %}

# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—Å–Ω–æ–≤–Ω–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ: `solve_scope` (2.478s, 49.9% –≤—Ä–µ–º–µ–Ω–∏)
**–ü—Ä–∏—á–∏–Ω–∞:** `cleanup_query` –∫–æ–ø–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `'q'` –≤–æ **–≤—Å–µ 36+ –ø–æ–ª–µ–π** –ø–æ–∏—Å–∫–∞, —Å–æ–∑–¥–∞–≤–∞—è –æ–≥—Ä–æ–º–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `solve_scope` –∏ `SearchQuery`.

### 2. –í—Ç–æ—Ä–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- `distinct()` –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
- JOIN –¥–ª—è `files__filename` —Å–æ–∑–¥–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- AccessControlList –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ö–æ—Ç—è –∑–∞–Ω–∏–º–∞—é—Ç <1% –≤—Ä–µ–º–µ–Ω–∏)

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Database index –Ω–∞ `filename`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `db_index=True` –≤ –ø–æ–ª–µ `filename` –º–æ–¥–µ–ª–∏ `DocumentFile`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `0081_documentfile_filename_index.py`
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –≤ –ë–î

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `cleanup_query`
- ‚úÖ –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω –º–µ—Ç–æ–¥ `cleanup_query` –≤ `DjangoSearchBackend`
- ‚úÖ –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞ (`'q'`) –∫–æ–ø–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ **4 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ø–æ–ª—è**:
  - `label`
  - `files__filename`
  - `description`
  - `uuid`
- ‚úÖ –í–º–µ—Å—Ç–æ 36+ –ø–æ–ª–µ–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 4

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `SearchQuery`
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –ø–æ–ª—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ)
- ‚úÖ –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ `count()` –≤—ã–∑–æ–≤—ã
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ debug —Ä–µ–∂–∏–º

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è queryset
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `select_related('document_type')` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –û–±—â–µ–µ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: **~5 —Å–µ–∫—É–Ω–¥**
- `solve_scope`: **2.478s** (49.9%)
- SQL –∑–∞–ø—Ä–æ—Å: **3.8s** (–Ω–æ EXPLAIN –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0.189ms - –ø—Ä–æ–±–ª–µ–º–∞ –≤ Python –∫–æ–¥–µ)

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –û–±—â–µ–µ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: **<1 —Å–µ–∫—É–Ω–¥–∞** (—É–ª—É—á—à–µ–Ω–∏–µ –≤ 5+ —Ä–∞–∑)
- `solve_scope`: **<0.3s** (—É–ª—É—á—à–µ–Ω–∏–µ –≤ 8+ —Ä–∞–∑)
- SQL –∑–∞–ø—Ä–æ—Å: **<0.1s**

## üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ –µ—â–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞:

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞**
   - –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Redis
   - TTL: 5-10 –º–∏–Ω—É—Ç
   - –ö–ª—é—á: hash(query + user_id)

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `distinct()`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `only()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `values_list('id')` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ ID, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤

3. **–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ PostgreSQL**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pg_trgm` extension –¥–ª—è `icontains`
   - –°–æ–∑–¥–∞—Ç—å GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—è—Ö
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `trigram_similar` –≤–º–µ—Å—Ç–æ `icontains`

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è AccessControlList**
   - –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `prefetch_related` –¥–ª—è ACL –∑–∞–ø–∏—Å–µ–π

5. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**
   - –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—è–º –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   - –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ `union()`

6. **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—è—Ö**
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `label`, `description` (–µ—Å–ª–∏ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –ø–æ–ª–µ–π

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. `mayan/apps/documents/models/document_file_models.py` - –¥–æ–±–∞–≤–ª–µ–Ω `db_index=True`
2. `mayan/apps/documents/migrations/0081_documentfile_filename_index.py` - –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞
3. `mayan/apps/dynamic_search/backends/django.py` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
   - `cleanup_query()` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - `SearchQuery.__init__()` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ª–µ–π
   - `_search()` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è queryset
4. `Dockerfile.app` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
1. –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ (`q=test`) - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <1s
2. –ü–æ–∏—Å–∫ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—é (`label=test`) - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <0.5s
3. –ü–æ–∏—Å–∫ –ø–æ filename (`files__filename=test`) - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <0.5s
4. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–π) - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <1.5s

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `solve_scope`
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –ø–æ–ª–µ–π –≤ `cleanup_query`
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ


<!DOCTYPE html>
<html>
<head>
    <title>Prime-EDMS Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ¯ Prime-EDMS Frontend â†” Backend Integration Test</h1>

    <div class="test-section">
        <h2>ğŸ”— System Status</h2>
        <div id="system-status">Checking...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ”‘ AutoAdmin Credentials Test</h2>
        <div id="credentials-status">Loading...</div>
        <div id="credentials-data"></div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ API Test</h2>
        <div id="api-test">Testing API connection...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ Integration Summary</h2>
        <div id="integration-summary">Running tests...</div>
    </div>

    <script>
        let testResults = {
            backend: false,
            frontend: false,
            injection: false,
            api: false
        };

        // Test 1: Check backend availability
        function testBackend() {
            return fetch('http://localhost:8080/')
                .then(response => response.text())
                .then(text => {
                    if (text.includes('Mayan EDMS')) {
                        testResults.backend = true;
                        return true;
                    }
                    throw new Error('Mayan EDMS not found in response');
                });
        }

        // Test 2: Check frontend availability
        function testFrontend() {
            return fetch('http://localhost:5173/')
                .then(response => response.text())
                .then(text => {
                    if (text.includes('html')) {
                        testResults.frontend = true;
                        return true;
                    }
                    throw new Error('Frontend not responding with HTML');
                });
        }

        // Test 3: Check JavaScript injection
        function testInjection() {
            return fetch('http://localhost:8080/authentication/login/')
                .then(response => response.text())
                .then(text => {
                    if (text.includes('Prime-EDMS Frontend Integration') && text.includes('window.autoadminCredentials')) {
                        testResults.injection = true;
                        return true;
                    }
                    throw new Error('JavaScript injection not found');
                });
        }

        // Test 4: Test API endpoint
        function testAPI() {
            return fetch('http://localhost:8080/admin-credentials-js/')
                .then(response => response.json())
                .then(data => {
                    console.log('API Response:', data);
                    testResults.api = true;
                    return data;
                });
        }

        // Main test runner
        async function runTests() {
            console.log('ğŸš€ Starting Prime-EDMS integration tests...');

            // Update system status
            document.getElementById('system-status').innerHTML = `
                <div class="status warning">ğŸ”„ Testing system components...</div>
            `;

            try {
                // Run all tests
                const [backendOk, frontendOk, injectionOk] = await Promise.all([
                    testBackend().catch(e => { console.error('Backend test failed:', e); return false; }),
                    testFrontend().catch(e => { console.error('Frontend test failed:', e); return false; }),
                    testInjection().catch(e => { console.error('Injection test failed:', e); return false; })
                ]);

                // Update system status
                let statusHtml = '';
                statusHtml += backendOk ? '<div class="status success">âœ… Backend (Mayan EDMS) running on port 8080</div>' :
                                         '<div class="status error">âŒ Backend not available</div>';
                statusHtml += frontendOk ? '<div class="status success">âœ… Frontend (Vue.js) running on port 5173</div>' :
                                          '<div class="status error">âŒ Frontend not available</div>';
                statusHtml += injectionOk ? '<div class="status success">âœ… JavaScript injection working</div>' :
                                           '<div class="status error">âŒ JavaScript injection failed</div>';

                document.getElementById('system-status').innerHTML = statusHtml;

                // Test API and credentials
                const apiData = await testAPI().catch(e => {
                    console.error('API test failed:', e);
                    document.getElementById('api-test').innerHTML = `
                        <div class="status error">âŒ API endpoint not accessible: ${e.message}</div>
                    `;
                    return null;
                });

                if (apiData) {
                    document.getElementById('api-test').innerHTML = `
                        <div class="status success">âœ… API endpoint responding</div>
                        <pre>${JSON.stringify(apiData, null, 2)}</pre>
                    `;

                    // Test credentials loading (simulate injection)
                    window.autoadminCredentials = apiData;
                    const credentials = getAutoAdminCredentials();

                    document.getElementById('credentials-status').innerHTML =
                        credentials ?
                        '<div class="status success">âœ… Credentials loaded successfully</div>' :
                        '<div class="status error">âŒ No valid credentials found</div>';

                    if (credentials) {
                        document.getElementById('credentials-data').innerHTML = `
                            <strong>Username:</strong> ${credentials.username || 'N/A'}<br>
                            <strong>Email:</strong> ${credentials.email || 'N/A'}<br>
                            <strong>Password:</strong> ${credentials.password ? 'â€¢'.repeat(credentials.password.length) : 'N/A'}<br>
                            <strong>Auto-generated:</strong> ${credentials.is_auto_generated}
                        `;
                    }
                }

                // Generate summary
                const allTests = Object.values(testResults).every(result => result);
                document.getElementById('integration-summary').innerHTML = `
                    <div class="status ${allTests ? 'success' : 'error'}">
                        ${allTests ? 'ğŸ‰' : 'âš ï¸'} Integration Status: ${allTests ? 'FULLY WORKING' : 'PARTIALLY WORKING'}
                    </div>
                    <ul>
                        <li>Backend â†” Frontend communication: ${testResults.api ? 'âœ… Working' : 'âŒ Failed'}</li>
                        <li>Auto-login functionality: ${testResults.api && testResults.injection ? 'âœ… Ready' : 'âŒ Needs work'}</li>
                        <li>User experience: ${allTests ? 'âœ… Seamless' : 'âš ï¸ Manual intervention required'}</li>
                    </ul>
                    ${allTests ? '<p><strong>ğŸš€ System is ready for production use!</strong></p>' : '<p>Please check server logs and restart components if needed.</p>'}
                `;

            } catch (error) {
                console.error('Test suite failed:', error);
                document.getElementById('system-status').innerHTML = `
                    <div class="status error">âŒ Test suite failed: ${error.message}</div>
                `;
            }
        }

        // Frontend credentials function (same as in authService.ts)
        function getAutoAdminCredentials() {
            try {
                if (typeof window !== 'undefined' && window.autoadminCredentials) {
                    const credentials = window.autoadminCredentials;
                    return credentials.is_auto_generated ? credentials : null;
                }
                return null;
            } catch (error) {
                console.warn('Could not get auto admin credentials:', error);
                return null;
            }
        }

        // Start tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>

# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Notification Center)
## MAD DAM v1.0 Enterprise | –§—Ä–æ–Ω—Ç–µ–Ω–¥ Vue 3 + –ë—ç–∫–µ–Ω–¥ Django Mayan

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.1  
**–î–∞—Ç–∞:** 24 –¥–µ–∫–∞–±—Ä—è 2025 –≥.  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 24 –¥–µ–∫–∞–±—Ä—è 2025 –≥. (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –±–µ–∫–µ–Ω–¥–∞ Mayan EDMS)  
**–ê–≤—Ç–æ—Ä:** Chief Digital & Technology Officer  
**–°—Ç–∞—Ç—É—Å:** READY FOR DEVELOPMENT  

---

## üìã –û–ì–õ–ê–í–õ–ï–ù–ò–ï

1. [–û–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞](#–æ–±–∑–æ—Ä-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
3. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ë–î](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∫-–±–¥)
4. [API —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è](#api-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è)
5. [–ë—ç–∫–µ–Ω–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (Django)](#–±—ç–∫–µ–Ω–¥-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-django)
6. [–§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (Vue 3)](#—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-vue-3)
7. [WebSocket / Real-time](#websocket--real-time)
8. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
9. [Timeline —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#timeline-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
10. [–ß–µ–∫–ª–∏—Å—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞](#—á–µ–∫–ª–∏—Å—Ç-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞)

---

## –û–ë–ó–û–† –§–£–ù–ö–¶–ò–û–ù–ê–õ–ê

### 1.1 –¶–µ–ª—å –º–æ–¥—É–ª—è

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **Notification Center** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π MAD DAM —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:

- ‚úÖ –†–æ–ª–µ–≤–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∏—è (Admin, Editor, Viewer)
- ‚úÖ –î–µ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏)
- ‚úÖ Real-time –¥–æ—Å—Ç–∞–≤–∫–∏ (WebSocket)
- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –∞—Ä—Ö–∏–≤–∞
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ–¥–ø–∏—Å–∫–∏/–æ—Ç–ø–∏—Å–∫–∏)

### 1.2 –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|---------|
| **Popover Panel** | –í—ã–ø–∞–¥–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ |
| **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** | –í—Å–µ, –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ, –í–∞–∂–Ω—ã–µ |
| **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞** | –ü–æ –¥–∞—Ç–∞–º (–°–µ–≥–æ–¥–Ω—è, –í—á–µ—Ä–∞, –†–∞–Ω–µ–µ) |
| **–î–µ–π—Å—Ç–≤–∏—è** | View, Download, Reply, Delete |
| **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** | –°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö, –±–µ–π–¥–∂ –Ω–∞ –∏–∫–æ–Ω–∫–µ |
| **–ê—Ä—Ö–∏–≤** | –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ –≤—Å–µ–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ |
| **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** | –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –ø–æ —Ä–æ–ª—è–º |
| **Real-time** | WebSocket –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ |

### 1.3 –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ —Ä–æ–ª—è–º)

#### Admin (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

| –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü—Ä–∏–º–µ—Ä | –î–µ–π—Å—Ç–≤–∏–µ |
|-------------|-----------|--------|----------|
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ | üî¥ HIGH | "–°–±–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ S3" | [–ü–æ–≤—Ç–æ—Ä–∏—Ç—å] |
| –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –∫–≤–æ—Ç—ã | üü° MEDIUM | "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 490GB –∏–∑ 500GB" | [–ü–µ—Ä–µ–π—Ç–∏ –≤ —Ç–∞—Ä–∏—Ñ] |
| –ù–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ | üîµ LOW | "3 –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" | [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ] |
| –ü—Ä–æ–±–ª–µ–º—ã —Å API | üî¥ HIGH | "API WB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω 10 –º–∏–Ω" | [–°—Ç–∞—Ç—É—Å] |
| –ó–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã | üü¢ INFO | "–ù–æ—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã" | [–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–∞] |

#### Editor (–ö–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä)

| –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü—Ä–∏–º–µ—Ä | –î–µ–π—Å—Ç–≤–∏–µ |
|-------------|-----------|--------|----------|
| AI-–∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω | üü¢ INFO | "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 98 –∏–∑ 100 —Ñ–∞–π–ª–æ–≤" | [–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏] |
| –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ | üü¢ INFO | "–í–∏–¥–µ–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ" | [–°–∫–∞—á–∞—Ç—å] |
| –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π | üîµ LOW | "@Ivan: –ü—Ä–æ–≤–µ—Ä—å —Ü–≤–µ—Ç–∞" | [–û—Ç–≤–µ—Ç–∏—Ç—å] |
| –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ | üü° MEDIUM | "@Maria —É–ø–æ–º—è–Ω—É–ª–∞ –≤–∞—Å" | [–ü—Ä–æ—Å–º–æ—Ç—Ä] |
| –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ | üîµ LOW | "–°—Ç–∞—Ç—É—Å: –û–¥–æ–±—Ä–µ–Ω–æ" | [–ü–µ—Ä–µ–π—Ç–∏] |
| –î–æ—Å—Ç—É–ø –æ—Ç–æ–∑–≤–∞–Ω | üü† MEDIUM | "–î–æ—Å—Ç—É–ø –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω" | ‚Äî |

#### Viewer (–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

| –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü—Ä–∏–º–µ—Ä | –î–µ–π—Å—Ç–≤–∏–µ |
|-------------|-----------|--------|----------|
| –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ | üü° MEDIUM | "–í–∞—Å —É–ø–æ–º—è–Ω—É–ª–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" | [–ü—Ä–æ—Å–º–æ—Ç—Ä] |
| –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π | üîµ LOW | "–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" | [–û—Ç–≤–µ—Ç–∏—Ç—å] |
| –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ | üîµ LOW | "–°—Ç–∞—Ç—É—Å –∞—Å—Å–µ—Ç–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è" | [–ü—Ä–æ—Å–º–æ—Ç—Ä] |
| –î–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω | üü° MEDIUM | "–í–∞–º –¥–∞–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏" | [–û—Ç–∫—Ä—ã—Ç—å] |

---

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

### 2.1 –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Frontend (Vue 3)                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ NotificationCenter (Popover)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ NotificationList (–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª)           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ NotificationCard (–ö–∞—Ä—Ç–æ—á–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ NotificationFilter (–í–∫–ª–∞–¥–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ NotificationSettings (–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                           ‚Üì                                 ‚îÇ
‚îÇ              Pinia Store (notificationStore)                ‚îÇ
‚îÇ            ‚îú‚îÄ‚îÄ state.notifications[]                        ‚îÇ
‚îÇ            ‚îú‚îÄ‚îÄ state.unreadCount                            ‚îÇ
‚îÇ            ‚îú‚îÄ‚îÄ actions.fetchNotifications()                 ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ actions.markAsRead()                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì                                       ‚Üì
   REST API                              WebSocket
   (HTTP)                             (Socket.IO)
         ‚Üì                                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Backend (Django + DRF)                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Views (NotificationViewSet)                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ GET /api/v4/notifications/                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ PATCH /api/v4/notifications/{id}/read/           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ POST /api/v4/notifications/read-all/             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ DELETE /api/v4/notifications/{id}/                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                           ‚Üì                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Models                                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ Notification                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ NotificationPreference                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ NotificationTemplate                             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                           ‚Üì                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Celery Tasks + Event Signals                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ send_notification_async()                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ cleanup_old_notifications()                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ Signal handlers (on_asset_uploaded, etc.)        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
    PostgreSQL / Redis
    (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ + –∫—ç—à)

### 2.2 Flow —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

Event –≤ —Å–∏—Å—Ç–µ–º–µ (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —Ç.–¥.)
    ‚Üì
EventType.commit() (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º Mayan EDMS)
    ‚Üì
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ EventSubscription / ObjectEventSubscription
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ NotificationPreference (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: email, quiet hours)
    ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ Notification –æ–±—ä–µ–∫—Ç–∞ –≤ –ë–î (—Å title, message, priority, actions)
    ‚Üì
Celery Task: send_notification_async()
    ‚îú‚îÄ Email (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
    ‚îî‚îÄ WebSocket push (real-time)
    ‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –∫—ç—à (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
    ‚Üì
Frontend:
    ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ REST API / WebSocket
    ‚îú‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç Pinia Store
    ‚îú‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ–π–¥–∂ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ
    ‚îî‚îÄ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ Popover Panel

### 2.3 –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CREATED     ‚îÇ  ‚Äî –¢–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–æ, –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SENT        ‚îÇ  ‚Äî –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø–∏—Å—å–º–æ, WebSocket)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ (frontend: –∫–ª–∏–∫ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
     ‚îÇ
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ READ        ‚îÇ  ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ (frontend: —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –∞—Ä—Ö–∏–≤)
     ‚îÇ
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ARCHIVED    ‚îÇ  ‚Äî –í –∞—Ä—Ö–∏–≤–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ (auto cleanup –ø–æ—Å–ª–µ 90 –¥–Ω–µ–π)
     ‚îÇ
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DELETED     ‚îÇ  ‚Äî –£–¥–∞–ª–µ–Ω–æ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

---

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ë–î

### 3.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã: events_notification

**–í–ê–ñ–ù–û:** –í Mayan EDMS —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ `events_notification` —Å –ø–æ–ª—è–º–∏:
- `id` (BIGSERIAL PRIMARY KEY)
- `user_id` (ForeignKey –∫ auth_user)
- `action_id` (ForeignKey –∫ actstream.Action)
- `read` (BooleanField)

**–ó–∞–¥–∞—á–∞:** –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é:

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ events_notification
ALTER TABLE events_notification
    ADD COLUMN uuid UUID UNIQUE DEFAULT gen_random_uuid(),
    ADD COLUMN title VARCHAR(255),
    ADD COLUMN message TEXT,
    ADD COLUMN icon_type VARCHAR(50) DEFAULT 'info',
    ADD COLUMN icon_url VARCHAR(255),
    
    -- –¢–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –¥–∞–Ω–Ω—ã–µ
    ADD COLUMN event_type VARCHAR(50),  -- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ action.verb
    ADD COLUMN event_data JSONB DEFAULT '{}',
    
    -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    ADD COLUMN priority VARCHAR(20) DEFAULT 'NORMAL',
    ADD COLUMN state VARCHAR(20) DEFAULT 'CREATED',
    
    -- –î–µ–π—Å—Ç–≤–∏—è (–∫–Ω–æ–ø–∫–∏)
    ADD COLUMN actions JSONB DEFAULT '[]',
    
    -- –°–≤—è–∑—å —Å –æ–±—ä–µ–∫—Ç–æ–º (—á–µ—Ä–µ–∑ GenericForeignKey)
    ADD COLUMN content_type_id INTEGER REFERENCES django_content_type(id) ON DELETE SET NULL,
    ADD COLUMN object_id BIGINT,
    
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    ADD COLUMN sent_at TIMESTAMP,
    ADD COLUMN read_at TIMESTAMP,
    ADD COLUMN archived_at TIMESTAMP,
    ADD COLUMN deleted_at TIMESTAMP,
    ADD COLUMN expires_at TIMESTAMP,
    
    -- –§–ª–∞–≥–∏
    ADD COLUMN is_mutable BOOLEAN DEFAULT TRUE,
    ADD COLUMN is_removable BOOLEAN DEFAULT TRUE,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    ADD COLUMN metadata JSONB DEFAULT '{}';

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
CREATE INDEX idx_events_notification_state ON events_notification(state);
CREATE INDEX idx_events_notification_created_at ON events_notification(created_at DESC);
CREATE INDEX idx_events_notification_unread ON events_notification(user_id, state);
CREATE INDEX idx_events_notification_event_type ON events_notification(event_type);
CREATE INDEX idx_events_notification_priority ON events_notification(priority);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
CREATE INDEX idx_events_notification_unread_count ON events_notification(user_id) 
WHERE state = 'SENT';
```

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è (`user_id`, `action_id`, `read`) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ù–æ–≤—ã–µ –ø–æ–ª—è –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ NULL –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
- Data migration –∑–∞–ø–æ–ª–Ω–∏—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å–º. —Ä–∞–∑–¥–µ–ª 3.5)

### 3.2 –¢–∞–±–ª–∏—Ü–∞: NotificationPreference

**–í–ê–ñ–ù–û:** –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã Mayan EDMS:
- `events_eventsubscription` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
- `events_objecteventsubscription` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

`NotificationPreference` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫**, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –ø–æ–¥–ø–∏—Å–æ–∫.

```sql
CREATE TABLE notifications_preference (
    id BIGSERIAL PRIMARY KEY,
    
    user_id INTEGER NOT NULL UNIQUE REFERENCES auth_user(id) ON DELETE CASCADE,
    
    -- –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    notifications_enabled BOOLEAN DEFAULT TRUE,
    email_notifications_enabled BOOLEAN DEFAULT TRUE,
    push_notifications_enabled BOOLEAN DEFAULT TRUE,
    
    -- Email digest
    email_digest_enabled BOOLEAN DEFAULT FALSE,
    email_digest_frequency VARCHAR(20),  -- 'daily', 'weekly', 'never'
    
    -- –¢–∏—Ö–∏–µ —á–∞—Å—ã
    quiet_hours_enabled BOOLEAN DEFAULT FALSE,
    quiet_hours_start TIME,  -- "22:00"
    quiet_hours_end TIME,    -- "08:00"
    
    -- –Ø–∑—ã–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    notification_language VARCHAR(10) DEFAULT 'ru',
    
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id)
);
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–ª–µ `subscriptions` —É–¥–∞–ª–µ–Ω–æ –∏–∑ NotificationPreference, —Ç–∞–∫ –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `EventSubscription` –∏ `ObjectEventSubscription` –≤ Mayan EDMS.

### 3.3 –¢–∞–±–ª–∏—Ü–∞: NotificationTemplate

CREATE TABLE notifications_template (
    id BIGSERIAL PRIMARY KEY,
    
    event_type VARCHAR(50) UNIQUE NOT NULL,  -- 'asset_uploaded', 'ai_completed', etc.
    
    title_template VARCHAR(255),  -- "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {asset_name}"
    message_template TEXT,
    icon_type VARCHAR(50),
    icon_url VARCHAR(255),
    
    default_priority VARCHAR(20),
    
    -- Roles who should receive
    recipients JSONB,  -- { "admin": true, "editor": true, "viewer": false }
    
    actions JSONB,  -- Default actions for this event type
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_event_type (event_type)
);

### 3.4 –¢–∞–±–ª–∏—Ü–∞: NotificationLog

CREATE TABLE notifications_log (
    id BIGSERIAL PRIMARY KEY,
    
    notification_id BIGINT NOT NULL REFERENCES events_notification(id) ON DELETE CASCADE,
    
    action VARCHAR(50),  -- 'created', 'sent', 'viewed', 'clicked', 'deleted'
    action_data JSONB,
    
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_notification_id (notification_id),
    INDEX idx_timestamp (timestamp)
);

### 3.5 Data Migration –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ó–∞–¥–∞—á–∞:** –ó–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è (`title`, `message`, `priority`, `state`, `event_type`) –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ `events_notification`.

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `Notification` –ø–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–π `Action` —á–µ—Ä–µ–∑ `action_id`
2. –ò–∑–≤–ª–µ—á—å `event_type` –∏–∑ `Action.verb`
3. –ù–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `NotificationTemplate` –ø–æ `event_type`
4. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `title` –∏ `message` –∏–∑ —à–∞–±–ª–æ–Ω–∞, –ø–æ–¥—Å—Ç–∞–≤–∏–≤ –¥–∞–Ω–Ω—ã–µ –∏–∑ `Action`
5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `priority` –∏ `state` –∏–∑ —à–∞–±–ª–æ–Ω–∞
6. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `event_type = Action.verb`
7. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `state = 'SENT'` –µ—Å–ª–∏ `read = False`, –∏–Ω–∞—á–µ `state = 'READ'`

**–ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏:**
```python
# migrations/0002_populate_notification_fields.py

from django.db import migrations
from django.utils import timezone

def populate_notifications(apps, schema_editor):
    """–ó–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    Notification = apps.get_model('events', 'Notification')
    NotificationTemplate = apps.get_model('notifications', 'NotificationTemplate')
    Action = apps.get_model('actstream', 'Action')
    
    for notification in Notification.objects.filter(title__isnull=True):
        try:
            action = Action.objects.get(pk=notification.action_id)
            event_type = action.verb
            
            # –ù–∞–π—Ç–∏ —à–∞–±–ª–æ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
            template = NotificationTemplate.objects.filter(
                event_type=event_type
            ).first()
            
            if template:
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è title –∏ message –∏–∑ —à–∞–±–ª–æ–Ω–∞
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Action (actor, target, action_object)
                context = {
                    'actor': str(action.actor) if action.actor else '',
                    'target': str(action.target) if action.target else '',
                    'action_object': str(action.action_object) if action.action_object else '',
                    'timestamp': action.timestamp.strftime('%d.%m.%Y %H:%M')
                }
                
                notification.title = template.title_template.format(**context)
                notification.message = template.message_template.format(**context)
                notification.priority = template.default_priority
                notification.icon_type = template.icon_type
                notification.icon_url = template.icon_url or ''
                notification.actions = template.actions or []
            else:
                # Fallback: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ Action
                notification.title = f"–°–æ–±—ã—Ç–∏–µ: {event_type}"
                notification.message = f"–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {action}"
                notification.priority = 'NORMAL'
                notification.icon_type = 'info'
            
            # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å event_type –∏ state
            notification.event_type = event_type
            if notification.read:
                notification.state = 'READ'
                notification.read_at = timezone.now()
            else:
                notification.state = 'SENT'
                notification.sent_at = timezone.now()
            
            notification.save()
            
        except Exception as e:
            # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
            print(f"Error processing notification {notification.id}: {e}")

def reverse_populate(apps, schema_editor):
    """–û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"""
    # –ú–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è, –Ω–æ —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
    pass

class Migration(migrations.Migration):
    dependencies = [
        ('events', '0003_notification'),  # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
        ('notifications', '0001_initial'),  # –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å NotificationTemplate
    ]

    operations = [
        migrations.RunPython(populate_notifications, reverse_populate),
    ]
```

---

## API –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø

**–í–ê–ñ–ù–û:** –í—Å–µ –Ω–æ–≤—ã–µ API endpoints —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ `headless_api` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º endpoint `/api/v4/events/notifications/`.

### 4.1 GET /api/v4/headless/notifications/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Query Parameters:**
GET /api/v4/headless/notifications/?state=SENT&page=1&page_size=20&sort=-created_at

- `state` ‚Äî CREATED | SENT | READ | ARCHIVED | DELETED | ALL (default: SENT)
- `page` ‚Äî pagination (default 1)
- `page_size` ‚Äî (default 20, max 100)
- `sort_by` ‚Äî created_at | priority (default: -created_at)
- `filter_event` ‚Äî —Ñ–∏–ª—å—Ç—Ä –ø–æ event_type (e.g., "asset_uploaded")

**Response (200 OK):**
{
  "count": 45,
  "next": "https://api.maddam.ru/api/v4/headless/notifications/?page=2",
  "previous": null,
  "unread_count": 3,
  "results": [
    {
      "id": 1001,
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "title": "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
      "message": "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 98 –∏–∑ 100 —Ñ–∞–π–ª–æ–≤. AI –∞–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ.",
      "event_type": "asset_uploaded",
      "event_data": {
        "asset_id": "uuid-123",
        "count": 100,
        "processed": 98
      },
      "priority": "NORMAL",
      "state": "SENT",
      "icon_type": "success",
      "icon_url": "https://cdn.maddam.ru/icons/success.svg",
      "actions": [
        {
          "id": "view",
          "label": "–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
          "url": "/collections/uuid-123",
          "type": "link",
          "icon": "arrow-right"
        },
        {
          "id": "download",
          "label": "–°–∫–∞—á–∞—Ç—å",
          "url": "/api/v4/notifications/1001/download/",
          "type": "button",
          "style": "secondary"
        }
      ],
      "created_at": "2025-12-24T10:30:00Z",
      "read_at": null,
      "expires_at": "2026-03-24T10:30:00Z"
    }
  ]
}

**Pagination:** Standard DRF pagination

---

### 4.2 GET /api/v4/headless/notifications/{id}/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –æ–¥–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**Response (200 OK):** –ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç Notification

---

### 4.3 PATCH /api/v4/headless/notifications/{id}/read/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ

**Request:**
{}

**Response (200 OK):**
{
  "id": 1001,
  "state": "READ",
  "read_at": "2025-12-24T10:35:00Z"
}

---

### 4.4 POST /api/v4/headless/notifications/read-all/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

**Request:**
{
  "filter_event_type": "asset_uploaded"  // optional, specific event type only
}

**Response (200 OK):**
{
  "marked_count": 15,
  "unread_count": 0
}

---

### 4.5 DELETE /api/v4/headless/notifications/{id}/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**Response (204 No Content)**

---

### 4.6 GET /api/v4/headless/notifications/unread-count/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–ª—è –±–µ–π–¥–∂–∞)

**Response (200 OK):**
{
  "unread_count": 3,
  "has_urgent": true,
  "urgent_count": 1
}

---

### 4.7 GET /api/v4/headless/notifications/preferences/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Response (200 OK):**
{
  "id": 5,
  "user_id": 123,
  "notifications_enabled": true,
  "email_notifications_enabled": true,
  "push_notifications_enabled": true,
  "email_digest_enabled": false,
  "quiet_hours_enabled": true,
  "quiet_hours_start": "22:00",
  "quiet_hours_end": "08:00",
  "notification_language": "ru"
}

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–ª–µ `subscriptions` —É–¥–∞–ª–µ–Ω–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints Mayan EDMS:
- `GET /api/v4/events/event_types/subscriptions/` ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/v4/events/event_types/{id}/subscribe/` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è

---

### 4.8 PATCH /api/v4/headless/notifications/preferences/

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏)

**Request:**
{
  "notifications_enabled": true,
  "email_notifications_enabled": true,
  "quiet_hours_enabled": true,
  "quiet_hours_start": "22:00",
  "quiet_hours_end": "08:00"
}

**Response (200 OK):** –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints Mayan EDMS, –Ω–µ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç endpoint.

---

### 4.9 WebSocket: /ws/notifications/

**–û–ø–∏—Å–∞–Ω–∏–µ:** WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**Connection URL:**
ws://localhost:8000/ws/notifications/?token={jwt_token}

**Incoming Message (–æ—Ç —Å–µ—Ä–≤–µ—Ä–∞):**
{
  "type": "notification.new",
  "data": {
    "id": 1001,
    "title": "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
    "message": "...",
    "priority": "NORMAL",
    "created_at": "2025-12-24T10:30:00Z"
  }
}

**Outgoing Message (–æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, heartbeat):**
{
  "type": "ping",
  "timestamp": "2025-12-24T10:30:00Z"
}

---

## –ë–≠–ö–ï–ù–î –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (DJANGO)

### 5.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–í–ê–ñ–ù–û:** –ù–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `notifications` —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º `mayan.apps.events`.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
mayan/apps/
‚îú‚îÄ‚îÄ events/                    # –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Mayan EDMS
‚îÇ   ‚îú‚îÄ‚îÄ models.py             # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–æ–¥–µ–ª—å Notification (—Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è)
‚îÇ   ‚îú‚îÄ‚îÄ classes.py            # EventType.commit() (—Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ notifications/            # –ù–û–í–û–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ admin.py              # Django Admin
    ‚îú‚îÄ‚îÄ apps.py              # App config
    ‚îú‚îÄ‚îÄ models.py            # NotificationPreference, NotificationTemplate, NotificationLog
    ‚îú‚îÄ‚îÄ serializers.py       # DRF Serializers
    ‚îú‚îÄ‚îÄ views.py             # ViewSets (–¥–ª—è headless_api)
    ‚îú‚îÄ‚îÄ urls.py              # URL routing (–¥–ª—è headless_api)
    ‚îú‚îÄ‚îÄ tasks.py             # Celery tasks
    ‚îú‚îÄ‚îÄ consumers.py         # WebSocket consumers
    ‚îú‚îÄ‚îÄ permissions.py       # Custom permissions
    ‚îú‚îÄ‚îÄ managers.py          # Custom managers (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ NotificationManager)
    ‚îú‚îÄ‚îÄ enums.py             # Constants & enums
    ‚îú‚îÄ‚îÄ utils.py             # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    ‚îú‚îÄ‚îÄ templates/           # Email templates
    ‚îÇ   ‚îú‚îÄ‚îÄ notification_email.html
    ‚îÇ   ‚îî‚îÄ‚îÄ notification_summary.html
    ‚îî‚îÄ‚îÄ tests/
        ‚îú‚îÄ‚îÄ test_models.py
        ‚îú‚îÄ‚îÄ test_views.py
        ‚îú‚îÄ‚îÄ test_tasks.py
        ‚îî‚îÄ‚îÄ test_websocket.py

mayan/apps/headless_api/
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îî‚îÄ‚îÄ notification_views.py  # HeadlessNotificationViewSet (–ù–û–í–´–ô)
‚îî‚îÄ‚îÄ urls.py                    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è notification endpoints
```

### 5.2 Models (models.py)

**–í–ê–ñ–ù–û:** –ú–æ–¥–µ–ª—å `Notification` —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ `mayan.apps.events`, –∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ.

#### 5.2.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–æ–¥–µ–ª–∏ Notification

**–§–∞–π–ª:** `mayan/apps/events/models.py`

```python
# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–æ–¥–µ–ª–∏ Notification
# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é (—Å–º. —Ä–∞–∑–¥–µ–ª 3.1)

from django.db import models
from django.utils import timezone
import uuid

# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è (–ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨):
# - user (ForeignKey)
# - action (ForeignKey –∫ Action)
# - read (BooleanField)

# –ù–û–í–´–ï –ø–æ–ª—è (–¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é):
class Notification(models.Model):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    
    # –ù–æ–≤—ã–µ –ø–æ–ª—è
    uuid = models.UUIDField(unique=True, default=uuid.uuid4, null=True, blank=True)
    title = models.CharField(max_length=255, null=True, blank=True)
    message = models.TextField(null=True, blank=True)
    icon_type = models.CharField(max_length=50, default='info', blank=True)
    icon_url = models.URLField(blank=True)
    event_type = models.CharField(max_length=50, null=True, blank=True)
    event_data = models.JSONField(default=dict, blank=True)
    priority = models.CharField(max_length=20, default='NORMAL', null=True, blank=True)
    state = models.CharField(max_length=20, default='CREATED', null=True, blank=True)
    actions = models.JSONField(default=list, blank=True)
    content_type = models.ForeignKey(ContentType, on_delete=models.SET_NULL, null=True, blank=True)
    object_id = models.BigIntegerField(null=True, blank=True)
    sent_at = models.DateTimeField(null=True, blank=True)
    read_at = models.DateTimeField(null=True, blank=True)
    archived_at = models.DateTimeField(null=True, blank=True)
    deleted_at = models.DateTimeField(null=True, blank=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    is_mutable = models.BooleanField(default=True)
    is_removable = models.BooleanField(default=True)
    metadata = models.JSONField(default=dict, blank=True)
    
    def mark_as_read(self):
        """–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ"""
        self.read = True  # –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ
        self.state = 'READ'
        self.read_at = timezone.now()
        self.save(update_fields=['read', 'state', 'read_at'])
    
    def archive(self):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤"""
        self.state = 'ARCHIVED'
        self.archived_at = timezone.now()
        self.save(update_fields=['state', 'archived_at'])
    
    def delete(self, *args, **kwargs):
        """Soft delete"""
        self.state = 'DELETED'
        self.deleted_at = timezone.now()
        self.save(update_fields=['state', 'deleted_at'])
```

#### 5.2.2 –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ notifications

**–§–∞–π–ª:** `mayan/apps/notifications/models.py`

```python
# models.py

from django.db import models
from django.contrib.auth.models import User
from django.contrib.contenttypes.models import ContentType
from django.utils import timezone
import uuid


class NotificationTemplate(models.Model):
    """–®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π"""
    
    EVENT_TYPE_CHOICES = [
        ('asset_uploaded', 'Asset Uploaded'),
        ('ai_analysis_completed', 'AI Analysis Completed'),
        ('comment_added', 'Comment Added'),
        ('user_mentioned', 'User Mentioned'),
        ('workflow_changed', 'Workflow Status Changed'),
        ('system_error', 'System Error'),
        ('storage_quota_warning', 'Storage Quota Warning'),
        ('new_user_registered', 'New User Registered'),
        ('distribution_completed', 'Distribution Completed'),
    ]
    
    event_type = models.CharField(
        max_length=50,
        unique=True,
        choices=EVENT_TYPE_CHOICES
    )
    title_template = models.CharField(max_length=255)
    message_template = models.TextField()
    
    icon_type = models.CharField(
        max_length=50,
        choices=[
            ('info', 'Info'),
            ('success', 'Success'),
            ('warning', 'Warning'),
            ('error', 'Error'),
            ('custom', 'Custom'),
        ],
        default='info'
    )
    icon_url = models.URLField(blank=True)
    
    default_priority = models.CharField(
        max_length=20,
        choices=[
            ('LOW', 'Low'),
            ('NORMAL', 'Normal'),
            ('HIGH', 'High'),
            ('URGENT', 'Urgent'),
        ],
        default='NORMAL'
    )
    
    # JSON: { 'admin': True, 'editor': True, 'viewer': False }
    recipients_config = models.JSONField(default=dict)
    
    # JSON: [{ 'id': 'view', 'label': '...', 'url': '...' }]
    actions = models.JSONField(default=list)
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'notifications_template'
        verbose_name = 'Notification Template'
        verbose_name_plural = 'Notification Templates'
    
    def __str__(self):
        return f"{self.event_type} - {self.title_template}"


class NotificationManager(models.Manager):
    """Custom manager –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def unread_for_user(self, user):
        return self.filter(user=user, state='SENT')
    
    def get_paginated(self, user, state=None, page=1, page_size=20):
        qs = self.filter(user=user)
        if state:
            qs = qs.filter(state=state)
        return qs.order_by('-created_at')[(page-1)*page_size:page*page_size]


class Notification(models.Model):
    """–û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    
    STATE_CHOICES = [
        ('CREATED', 'Created'),
        ('SENT', 'Sent'),
        ('READ', 'Read'),
        ('ARCHIVED', 'Archived'),
        ('DELETED', 'Deleted'),
    ]
    
    PRIORITY_CHOICES = [
        ('LOW', 'Low'),
        ('NORMAL', 'Normal'),
        ('HIGH', 'High'),
        ('URGENT', 'Urgent'),
    ]
    
    id = models.BigAutoField(primary_key=True)
    uuid = models.UUIDField(unique=True, default=uuid.uuid4)
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='notifications')
    
    title = models.CharField(max_length=255)
    message = models.TextField()
    
    event_type = models.CharField(max_length=50)
    event_data = models.JSONField(default=dict, blank=True)
    
    priority = models.CharField(
        max_length=20,
        choices=PRIORITY_CHOICES,
        default='NORMAL'
    )
    
    state = models.CharField(
        max_length=20,
        choices=STATE_CHOICES,
        default='CREATED'
    )
    
    icon_type = models.CharField(
        max_length=50,
        blank=True,
        default='info'
    )
    icon_url = models.URLField(blank=True)
    
    # JSON actions: [{ 'label': '...', 'url': '...', 'type': 'link|button' }]
    actions = models.JSONField(default=list, blank=True)
    
    # Polymorphic content type
    content_type = models.ForeignKey(
        ContentType,
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    object_id = models.BigIntegerField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    sent_at = models.DateTimeField(null=True, blank=True)
    read_at = models.DateTimeField(null=True, blank=True)
    archived_at = models.DateTimeField(null=True, blank=True)
    deleted_at = models.DateTimeField(null=True, blank=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    
    is_mutable = models.BooleanField(default=True)
    is_removable = models.BooleanField(default=True)
    
    metadata = models.JSONField(default=dict, blank=True)
    
    objects = NotificationManager()
    
    class Meta:
        db_table = 'notifications_notification'
        verbose_name = 'Notification'
        verbose_name_plural = 'Notifications'
        indexes = [
            models.Index(fields=['user', '-created_at']),
            models.Index(fields=['user', 'state']),
            models.Index(fields=['priority']),
            models.Index(fields=['event_type']),
        ]
    
    def __str__(self):
        return f"{self.title} - {self.user}"
    
    def mark_as_read(self):
        """–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ"""
        self.state = 'READ'
        self.read_at = timezone.now()
        self.save(update_fields=['state', 'read_at'])
        
        # Log action
        NotificationLog.objects.create(
            notification=self,
            action='read'
        )
    
    def archive(self):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤"""
        self.state = 'ARCHIVED'
        self.archived_at = timezone.now()
        self.save(update_fields=['state', 'archived_at'])
    
    def delete(self, *args, **kwargs):
        """Soft delete"""
        self.state = 'DELETED'
        self.deleted_at = timezone.now()
        self.save(update_fields=['state', 'deleted_at'])


class NotificationPreference(models.Model):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)"""
    
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='notification_preference')
    
    notifications_enabled = models.BooleanField(default=True)
    email_notifications_enabled = models.BooleanField(default=True)
    push_notifications_enabled = models.BooleanField(default=True)
    
    # –í–ê–ñ–ù–û: subscriptions —É–¥–∞–ª–µ–Ω–æ - –ø–æ–¥–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ EventSubscription / ObjectEventSubscription
    
    email_digest_enabled = models.BooleanField(default=False)
    email_digest_frequency = models.CharField(
        max_length=20,
        choices=[
            ('daily', 'Daily'),
            ('weekly', 'Weekly'),
            ('never', 'Never'),
        ],
        default='never'
    )
    
    quiet_hours_enabled = models.BooleanField(default=False)
    quiet_hours_start = models.TimeField(null=True, blank=True)
    quiet_hours_end = models.TimeField(null=True, blank=True)
    
    notification_language = models.CharField(
        max_length=10,
        default='ru'
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'notifications_preference'
        verbose_name = 'Notification Preference'
    
    def __str__(self):
        return f"Preferences for {self.user}"
    
    def is_subscribed_to_event(self, event_type):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —ç—Ç–æ—Ç —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ EventSubscription"""
        from mayan.apps.events.models import EventSubscription, StoredEventType
        
        try:
            stored_event_type = StoredEventType.objects.get(name=event_type)
            return EventSubscription.objects.filter(
                user=self.user,
                stored_event_type=stored_event_type
            ).exists()
        except StoredEventType.DoesNotExist:
            return False


class NotificationLog(models.Model):
    """–õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏"""
    
    notification = models.ForeignKey(
        'events.Notification',  # –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–µ–ª—å –≤ –¥—Ä—É–≥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        on_delete=models.CASCADE,
        related_name='logs'
    )
    action = models.CharField(max_length=50)
    action_data = models.JSONField(default=dict, blank=True)
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'notifications_log'
        verbose_name = 'Notification Log'
        indexes = [
            models.Index(fields=['notification', '-timestamp']),
        ]
    
    def __str__(self):
        return f"{self.notification.id} - {self.action}"

### 5.3 Serializers (serializers.py)

# serializers.py

from rest_framework import serializers
from .models import Notification, NotificationPreference, NotificationTemplate


class NotificationActionSerializer(serializers.Serializer):
    """–°–µ—Ä–∏–∞–ª–∏–∑–µ—Ä –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π (–∫–Ω–æ–ø–∫–∏) –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏"""
    id = serializers.CharField()
    label = serializers.CharField()
    url = serializers.URLField()
    type = serializers.ChoiceField(choices=['link', 'button'])
    icon = serializers.CharField(required=False, allow_blank=True)
    style = serializers.CharField(required=False, default='primary')


class NotificationSerializer(serializers.ModelSerializer):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    
    actions = NotificationActionSerializer(many=True, read_only=True)
    
    class Meta:
        model = Notification
        fields = [
            'id', 'uuid', 'title', 'message', 'event_type', 'event_data',
            'priority', 'state', 'icon_type', 'icon_url', 'actions',
            'created_at', 'sent_at', 'read_at', 'archived_at', 'expires_at'
        ]
        read_only_fields = [
            'id', 'uuid', 'created_at', 'sent_at', 'read_at', 'archived_at'
        ]


class NotificationListSerializer(serializers.ModelSerializer):
    """–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–µ—Ä–∏–∞–ª–∏–∑–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–æ–≤"""
    
    class Meta:
        model = Notification
        fields = [
            'id', 'uuid', 'title', 'message', 'priority', 'state',
            'icon_type', 'created_at', 'read_at'
        ]


class NotificationPreferenceSerializer(serializers.ModelSerializer):
    """–°–µ—Ä–∏–∞–ª–∏–∑–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    
    class Meta:
        model = NotificationPreference
        fields = [
            'notifications_enabled', 'email_notifications_enabled',
            'push_notifications_enabled', 'subscriptions',
            'email_digest_enabled', 'email_digest_frequency',
            'quiet_hours_enabled', 'quiet_hours_start', 'quiet_hours_end',
            'notification_language'
        ]
    
    def update(self, instance, validated_data):
        # Merge subscriptions instead of overwriting
        if 'subscriptions' in validated_data:
            instance.subscriptions.update(validated_data.pop('subscriptions'))
        return super().update(instance, validated_data)

### 5.4 Views (views.py)

**–í–ê–ñ–ù–û:** ViewSet —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `headless_api`, –∞ –Ω–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ `notifications`.

**–§–∞–π–ª:** `mayan/apps/headless_api/views/notification_views.py`

```python
# views.py

from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.db.models import Q
from django.utils import timezone
from mayan.apps.events.models import Notification  # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–æ–¥–µ–ª—å
from mayan.apps.notifications.models import NotificationPreference
from mayan.apps.notifications.serializers import (
    NotificationSerializer, NotificationListSerializer, NotificationPreferenceSerializer
)


class HeadlessNotificationViewSet(viewsets.ModelViewSet):
    """ViewSet –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏"""
    
    serializer_class = NotificationSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """–¢–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return Notification.objects.filter(
            user=self.request.user
        ).exclude(state='DELETED').order_by('-created_at')
    
    def get_serializer_class(self):
        """–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–∏–∞–ª–∏–∑–µ—Ä –¥–ª—è list action"""
        if self.action == 'list':
            return NotificationListSerializer
        return NotificationSerializer
    
    def list(self, request, *args, **kwargs):
        """GET /api/v4/headless/notifications/"""
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ state
        state = request.query_params.get('state', 'SENT')
        event_type = request.query_params.get('event_type')
        
        queryset = self.get_queryset()
        
        if state != 'ALL':
            queryset = queryset.filter(state=state)
        if event_type:
            queryset = queryset.filter(event_type=event_type)
        
        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response({
                'results': serializer.data,
                'unread_count': Notification.objects.unread_for_user(request.user).count(),
                'has_urgent': queryset.filter(priority='URGENT').exists()
            })
        
        serializer = self.get_serializer(queryset, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def unread_count(self, request):
        """GET /api/v4/headless/notifications/unread-count/"""
        unread = Notification.objects.unread_for_user(request.user).count()
        urgent = Notification.objects.filter(
            user=request.user,
            state='SENT',
            priority='URGENT'
        ).count()
        
        return Response({
            'unread_count': unread,
            'has_urgent': urgent > 0,
            'urgent_count': urgent
        })
    
    @action(detail=True, methods=['patch'])
    def read(self, request, pk=None):
        """PATCH /api/v4/headless/notifications/{id}/read/"""
        notification = self.get_object()
        notification.mark_as_read()
        
        serializer = self.get_serializer(notification)
        return Response(serializer.data)
    
    @action(detail=False, methods=['post'])
    def read_all(self, request):
        """POST /api/v4/headless/notifications/read-all/"""
        event_type = request.data.get('filter_event_type')
        
        queryset = Notification.objects.unread_for_user(request.user)
        if event_type:
            queryset = queryset.filter(event_type=event_type)
        
        count = queryset.count()
        queryset.update(
            state='READ',
            read_at=timezone.now()
        )
        
        return Response({
            'marked_count': count,
            'unread_count': Notification.objects.unread_for_user(request.user).count()
        })
    
    def destroy(self, request, *args, **kwargs):
        """DELETE /api/v4/headless/notifications/{id}/"""
        notification = self.get_object()
        notification.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)


class HeadlessNotificationPreferenceViewSet(viewsets.ViewSet):
    """ViewSet –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    
    permission_classes = [IsAuthenticated]
    
    @action(detail=False, methods=['get'])
    def preferences(self, request):
        """GET /api/v4/headless/notifications/preferences/"""
        pref, created = NotificationPreference.objects.get_or_create(user=request.user)
        serializer = NotificationPreferenceSerializer(pref)
        return Response(serializer.data)
    
    @action(detail=False, methods=['patch'])
    def update_preferences(self, request):
        """PATCH /api/v4/headless/notifications/preferences/"""
        pref, created = NotificationPreference.objects.get_or_create(user=request.user)
        serializer = NotificationPreferenceSerializer(pref, data=request.data, partial=True)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
```

### 5.5 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EventType.commit()

**–í–ê–ñ–ù–û:** –í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö signal handlers, —Ä–∞—Å—à–∏—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `EventType.commit()` –≤ `mayan.apps.events.classes`.

**–§–∞–π–ª:** `mayan/apps/notifications/utils.py`

```python
# utils.py

from django.apps import apps
from django.utils import timezone
from mayan.apps.events.models import Notification as EventNotification
from mayan.apps.notifications.models import NotificationTemplate, NotificationPreference


def create_enhanced_notification(user, action, event_type, template=None):
    """
    –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ Action –∏ —à–∞–±–ª–æ–Ω–∞.
    
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ EventType.commit().
    """
    # –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º)
    notification, created = EventNotification.objects.get_or_create(
        user=user,
        action=action,
        defaults={'read': False}
    )
    
    # –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç title, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å
    if not created and notification.title:
        return notification
    
    # –ù–∞–π—Ç–∏ —à–∞–±–ª–æ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
    if not template:
        template = NotificationTemplate.objects.filter(
            event_type=event_type,
            is_active=True
        ).first()
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NotificationPreference
    pref = NotificationPreference.objects.filter(user=user).first()
    if pref and not pref.notifications_enabled:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        return notification
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ EventSubscription (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º)
    # –≠—Ç–æ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ EventType.commit(), –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è title –∏ message –∏–∑ —à–∞–±–ª–æ–Ω–∞
    if template:
        context = {
            'actor': str(action.actor) if action.actor else '',
            'target': str(action.target) if action.target else '',
            'action_object': str(action.action_object) if action.action_object else '',
            'timestamp': action.timestamp.strftime('%d.%m.%Y %H:%M')
        }
        
        notification.title = template.title_template.format(**context)
        notification.message = template.message_template.format(**context)
        notification.priority = template.default_priority
        notification.icon_type = template.icon_type
        notification.icon_url = template.icon_url or ''
        notification.actions = template.actions or []
    else:
        # Fallback: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ Action
        notification.title = f"–°–æ–±—ã—Ç–∏–µ: {event_type}"
        notification.message = f"–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {action}"
        notification.priority = 'NORMAL'
        notification.icon_type = 'info'
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å event_type –∏ state
    notification.event_type = event_type
    notification.state = 'CREATED'
    notification.save()
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å Celery task –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    from mayan.apps.notifications.tasks import send_notification_async
    send_notification_async.delay(notification.id)
    
    return notification
```

**–§–∞–π–ª:** `mayan/apps/events/classes.py` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ—Ç–æ–¥–∞)

```python
# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ—Ç–æ–¥–∞ EventType.commit()
# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü –º–µ—Ç–æ–¥–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ Notification:

def commit(self, actor=None, action_object=None, target=None):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è Action ...
    
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑–æ–≤—ã—Ö Notification:
    for user in user_queryset:
        if result.action_object:
            base_notification = Notification.objects.create(action=result, user=user)
            # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            from mayan.apps.notifications.utils import create_enhanced_notification
            create_enhanced_notification(
                user=user,
                action=result,
                event_type=result.verb,
                template=None  # –ë—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            )
            continue
        
        if result.target:
            base_notification = Notification.objects.create(action=result, user=user)
            # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            from mayan.apps.notifications.utils import create_enhanced_notification
            create_enhanced_notification(
                user=user,
                action=result,
                event_type=result.verb,
                template=None
            )
            continue
    
    return result
```

**–§–∞–π–ª:** `mayan/apps/notifications/signals.py`

```python
# signals.py

from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth.models import User
from mayan.apps.notifications.models import NotificationPreference


@receiver(post_save, sender=User)
def create_notification_preference(sender, instance, created, **kwargs):
    """–°–æ–∑–¥–∞—Ç—å NotificationPreference –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if created:
        NotificationPreference.objects.get_or_create(user=instance)
```

### 5.6 Celery Tasks (tasks.py)

# tasks.py

from celery import shared_task
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.utils import timezone
from .models import Notification, NotificationPreference
from channels.layers import get_channel_layer
from asgiref.sync import async_to_sync
import logging

logger = logging.getLogger(__name__)


@shared_task(bind=True, max_retries=3)
def send_notification_async(self, notification_id):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    try:
        from mayan.apps.events.models import Notification
        notification = Notification.objects.get(id=notification_id)
        user = notification.user
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        pref = getattr(user, 'notification_preference', None)
        
        if pref and not pref.notifications_enabled:
            return
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ EventType.commit() —á–µ—Ä–µ–∑ EventSubscription
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ NotificationPreference –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        
        # –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
        notification.sent_at = timezone.now()
        notification.state = 'SENT'
        notification.save(update_fields=['sent_at', 'state'])
        
        # Email –æ—Ç–ø—Ä–∞–≤–∫–∞
        if pref.email_notifications_enabled:
            send_notification_email.delay(notification.id)
        
        # WebSocket –æ—Ç–ø—Ä–∞–≤–∫–∞ (real-time)
        send_websocket_notification.delay(notification.id)
        
    except Exception as exc:
        logger.error(f"Error sending notification {notification_id}: {exc}")
        raise self.retry(exc=exc, countdown=60)


@shared_task
def send_notification_email(notification_id):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ email"""
    try:
        notification = Notification.objects.get(id=notification_id)
        user = notification.user
        
        html_message = render_to_string(
            'notifications/notification_email.html',
            {
                'user': user,
                'notification': notification,
                'domain': 'maddam.ru'
            }
        )
        
        send_mail(
            subject=notification.title,
            message=notification.message,
            from_email='notifications@maddam.ru',
            recipient_list=[user.email],
            html_message=html_message,
            fail_silently=False,
        )
        
        logger.info(f"Email sent for notification {notification_id} to {user.email}")
        
    except Exception as exc:
        logger.error(f"Error sending email for notification {notification_id}: {exc}")


@shared_task
def send_websocket_notification(notification_id):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ (real-time)"""
    try:
        from mayan.apps.events.models import Notification
        notification = Notification.objects.get(id=notification_id)
        channel_layer = get_channel_layer()
        
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async_to_sync(channel_layer.group_send)(
            f"notifications_{notification.user.id}",
            {
                "type": "notification.new",
                "data": {
                    "id": notification.id,
                    "title": notification.title,
                    "message": notification.message,
                    "priority": notification.priority,
                    "icon_type": notification.icon_type,
                    "created_at": notification.created_at.isoformat()
                }
            }
        )
        
        logger.info(f"WebSocket notification sent for notification {notification_id}")
        
    except Exception as exc:
        logger.error(f"Error sending WebSocket notification {notification_id}: {exc}")


@shared_task
def cleanup_old_notifications():
    """–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π)"""
    from datetime import timedelta
    from mayan.apps.events.models import Notification
    
    cutoff_date = timezone.now() - timedelta(days=90)
    
    deleted_count, _ = Notification.objects.filter(
        action__timestamp__lt=cutoff_date,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º action.timestamp –≤–º–µ—Å—Ç–æ created_at
        state__in=['ARCHIVED', 'DELETED']
    ).delete()
    
    logger.info(f"Cleaned up {deleted_count} old notifications")

### 5.7 WebSocket Consumer (consumers.py)

**–§–∞–π–ª:** `mayan/apps/notifications/consumers.py`

```python
# consumers.py

import json
import logging
from channels.generic.websocket import AsyncWebsocketConsumer
from channels.db import database_sync_to_async
from django.contrib.auth.models import User
from mayan.apps.events.models import Notification

logger = logging.getLogger(__name__)


class NotificationConsumer(AsyncWebsocketConsumer):
    """WebSocket consumer –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    
    async def connect(self):
        """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket"""
        self.user = self.scope['user']
        self.user_id = self.user.id
        
        if not self.user.is_authenticated:
            await self.close()
            return
        
        # –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.group_name = f'notifications_{self.user_id}'
        await self.channel_layer.group_add(
            self.group_name,
            self.channel_name
        )
        
        await self.accept()
        logger.info(f"User {self.user_id} connected to notifications WebSocket")
    
    async def disconnect(self, close_code):
        """–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç WebSocket"""
        await self.channel_layer.group_discard(
            self.group_name,
            self.channel_name
        )
        logger.info(f"User {self.user_id} disconnected from notifications WebSocket")
    
    async def receive(self, text_data):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞"""
        try:
            data = json.loads(text_data)
            message_type = data.get('type')
            
            if message_type == 'ping':
                # Heartbeat
                await self.send(json.dumps({
                    'type': 'pong',
                    'timestamp': data.get('timestamp')
                }))
            
        except json.JSONDecodeError as e:
            logger.error(f"Invalid JSON from user {self.user_id}: {e}")
    
    # Handler –¥–ª—è –≥—Ä—É–ø–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
    async def notification_new(self, event):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É"""
        await self.send(json.dumps({
            'type': 'notification.new',
            'data': event['data']
        }))
    
    async def notification_read(self, event):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ)"""
        await self.send(json.dumps({
            'type': 'notification.read',
            'notification_id': event['notification_id']
        }))

### 5.8 URL Routing (urls.py)

**–í–ê–ñ–ù–û:** URL routing –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `headless_api`, –∞ –Ω–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

**–§–∞–π–ª:** `mayan/apps/headless_api/urls.py`

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª headless_api/urls.py

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views.notification_views import (
    HeadlessNotificationViewSet, HeadlessNotificationPreferenceViewSet
)

# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ URL patterns...
# ...

# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ patterns –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
urlpatterns += [
    path('notifications/', HeadlessNotificationViewSet.as_view({'get': 'list'}), name='notification-list'),
    path('notifications/<int:pk>/', HeadlessNotificationViewSet.as_view({'get': 'retrieve'}), name='notification-detail'),
    path('notifications/<int:pk>/read/', HeadlessNotificationViewSet.as_view({'patch': 'read'}), name='notification-read'),
    path('notifications/read-all/', HeadlessNotificationViewSet.as_view({'post': 'read_all'}), name='notification-read-all'),
    path('notifications/unread-count/', HeadlessNotificationViewSet.as_view({'get': 'unread_count'}), name='notification-unread-count'),
    path('notifications/preferences/', 
         HeadlessNotificationPreferenceViewSet.as_view({'get': 'preferences', 'patch': 'update_preferences'}),
         name='notification-preferences'),
]
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint `/api/v4/events/notifications/` –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

### 5.9 Django Admin (admin.py)

**–§–∞–π–ª:** `mayan/apps/notifications/admin.py`

```python
# admin.py

from django.contrib import admin
from mayan.apps.events.models import Notification  # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–æ–¥–µ–ª—å
from .models import NotificationTemplate, NotificationPreference, NotificationLog


# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–¥–º–∏–Ω–∞ –¥–ª—è Notification (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å proxy admin –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–µ—Ä–µ–∑ admin.site.unregister()

@admin.register(NotificationTemplate)
class NotificationTemplateAdmin(admin.ModelAdmin):
    list_display = ('event_type', 'title_template', 'default_priority', 'is_active')
    list_filter = ('is_active', 'default_priority')


@admin.register(NotificationTemplate)
class NotificationTemplateAdmin(admin.ModelAdmin):
    list_display = ('event_type', 'title_template', 'default_priority', 'is_active')
    list_filter = ('is_active', 'default_priority')


@admin.register(NotificationPreference)
class NotificationPreferenceAdmin(admin.ModelAdmin):
    list_display = ('user', 'notifications_enabled', 'email_notifications_enabled')
    list_filter = ('notifications_enabled', 'email_notifications_enabled')


@admin.register(NotificationLog)
class NotificationLogAdmin(admin.ModelAdmin):
    list_display = ('notification', 'action', 'timestamp')
    list_filter = ('action', 'timestamp')
    readonly_fields = ('timestamp',)

---

## –§–†–û–ù–¢–ï–ù–î –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (VUE 3)

### 6.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ Notifications/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationBell.vue       # –ò–∫–æ–Ω–∫–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ + –±–µ–π–¥–∂
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationPopover.vue    # –í—ã–ø–∞–¥–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationCard.vue       # –ö–∞—Ä—Ç–æ—á–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationFilter.vue     # –í–∫–ª–∞–¥–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationEmpty.vue      # Empty state
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationSettings.vue   # –ú–æ–¥–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NotificationArchive.vue    # –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞—Ä—Ö–∏–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ notificationStore.ts           # Pinia store
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ notificationService.ts         # API client
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useWebSocket.ts                # WebSocket hook
‚îî‚îÄ‚îÄ ...

### 6.2 Pinia Store (notificationStore.ts)

// stores/notificationStore.ts

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { notificationService } from '@/services/notificationService'

export interface INotification {
  id: number
  uuid: string
  title: string
  message: string
  event_type: string
  priority: 'LOW' | 'NORMAL' | 'HIGH' | 'URGENT'
  state: 'CREATED' | 'SENT' | 'READ' | 'ARCHIVED' | 'DELETED'
  icon_type: string
  icon_url: string
  actions: INotificationAction[]
  created_at: string
  read_at: string | null
}

export interface INotificationAction {
  id: string
  label: string
  url: string
  type: 'link' | 'button'
  icon?: string
  style?: string
}

export const useNotificationStore = defineStore('notifications', () => {
  // State
  const notifications = ref<INotification[]>([])
  const unreadCount = ref(0)
  const hasUrgent = ref(false)
  const isLoading = ref(false)
  const currentFilter = ref<'all' | 'unread' | 'important'>('unread')
  const preferences = ref({
    notifications_enabled: true,
    email_notifications_enabled: true,
    subscriptions: {},
    quiet_hours_enabled: false
  })
  
  // Computed
  const filteredNotifications = computed(() => {
    switch (currentFilter.value) {
      case 'unread':
        return notifications.value.filter(n => n.state === 'SENT')
      case 'important':
        return notifications.value.filter(n => ['HIGH', 'URGENT'].includes(n.priority))
      default:
        return notifications.value
    }
  })
  
  const groupedByDate = computed(() => {
    const grouped: {
      [key: string]: INotification[]
    } = {
      today: [],
      yesterday: [],
      older: []
    }
    
    const today = new Date()
    const yesterday = new Date(today)
    yesterday.setDate(yesterday.getDate() - 1)
    
    filteredNotifications.value.forEach(notif => {
      const notifDate = new Date(notif.created_at)
      
      if (notifDate.toDateString() === today.toDateString()) {
        grouped.today.push(notif)
      } else if (notifDate.toDateString() === yesterday.toDateString()) {
        grouped.yesterday.push(notif)
      } else {
        grouped.older.push(notif)
      }
    })
    
    return grouped
  })
  
  // Actions
  const fetchNotifications = async (state = 'SENT', page = 1) => {
    isLoading.value = true
    try {
      const response = await notificationService.getNotifications({
        state,
        page,
        page_size: 20
      })
      
      notifications.value = response.results
      unreadCount.value = response.unread_count
      hasUrgent.value = response.has_urgent
      
    } catch (error) {
      console.error('Failed to fetch notifications:', error)
    } finally {
      isLoading.value = false
    }
  }
  
  const markAsRead = async (notificationId: number) => {
    try {
      await notificationService.markAsRead(notificationId)
      
      const notif = notifications.value.find(n => n.id === notificationId)
      if (notif) {
        notif.state = 'READ'
        notif.read_at = new Date().toISOString()
      }
      
      unreadCount.value = Math.max(0, unreadCount.value - 1)
      
    } catch (error) {
      console.error('Failed to mark notification as read:', error)
    }
  }
  
  const markAllAsRead = async () => {
    try {
      await notificationService.markAllAsRead()
      
      notifications.value.forEach(n => {
        if (n.state === 'SENT') {
          n.state = 'READ'
          n.read_at = new Date().toISOString()
        }
      })
      
      unreadCount.value = 0
      
    } catch (error) {
      console.error('Failed to mark all as read:', error)
    }
  }
  
  const deleteNotification = async (notificationId: number) => {
    try {
      await notificationService.deleteNotification(notificationId)
      
      notifications.value = notifications.value.filter(n => n.id !== notificationId)
      unreadCount.value = Math.max(0, unreadCount.value - 1)
      
    } catch (error) {
      console.error('Failed to delete notification:', error)
    }
  }
  
  const getUnreadCount = async () => {
    try {
      const response = await notificationService.getUnreadCount()
      unreadCount.value = response.unread_count
      hasUrgent.value = response.has_urgent
    } catch (error) {
      console.error('Failed to fetch unread count:', error)
    }
  }
  
  const fetchPreferences = async () => {
    try {
      const response = await notificationService.getPreferences()
      preferences.value = response
    } catch (error) {
      console.error('Failed to fetch preferences:', error)
    }
  }
  
  const updatePreferences = async (newPreferences: any) => {
    try {
      await notificationService.updatePreferences(newPreferences)
      preferences.value = newPreferences
    } catch (error) {
      console.error('Failed to update preferences:', error)
    }
  }
  
  const handleNewNotification = (notification: INotification) => {
    notifications.value.unshift(notification)
    unreadCount.value++
    
    if (notification.priority === 'URGENT') {
      hasUrgent.value = true
    }
  }
  
  const setFilter = (filter: 'all' | 'unread' | 'important') => {
    currentFilter.value = filter
  }
  
  return {
    // State
    notifications,
    unreadCount,
    hasUrgent,
    isLoading,
    currentFilter,
    preferences,
    
    // Computed
    filteredNotifications,
    groupedByDate,
    
    // Actions
    fetchNotifications,
    markAsRead,
    markAllAsRead,
    deleteNotification,
    getUnreadCount,
    fetchPreferences,
    updatePreferences,
    handleNewNotification,
    setFilter
  }
})

### 6.3 NotificationBell Component

<!-- components/Notifications/NotificationBell.vue -->

<template>
  <div class="notification-bell-container">
    <!-- –ò–∫–æ–Ω–∫–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ -->
    <button
      @click="togglePopover"
      :class="['bell-button', { active: isOpen }]"
      aria-label="Notifications"
      title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
    >
      <svg class="bell-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
        <path d="M13.73 21a2 2 0 0 1-3.46 0" />
      </svg>
      
      <!-- –ë–µ–π–¥–∂ —Å —á–∏—Å–ª–æ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö -->
      <span v-if="unreadCount > 0" class="badge">
        {{ unreadCount > 99 ? '99+' : unreadCount }}
      </span>
      
      <!-- –ö—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è urgent -->
      <span v-if="hasUrgent" class="urgent-indicator" title="–°—Ä–æ—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ" />
    </button>
    
    <!-- Popover –ø–∞–Ω–µ–ª—å -->
    <NotificationPopover 
      v-if="isOpen" 
      @close="closePopover"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useNotificationStore } from '@/stores/notificationStore'
import { useWebSocket } from '@/hooks/useWebSocket'
import NotificationPopover from './NotificationPopover.vue'

const notificationStore = useNotificationStore()
const { connect, disconnect } = useWebSocket()

const isOpen = ref(false)

const unreadCount = computed(() => notificationStore.unreadCount)
const hasUrgent = computed(() => notificationStore.hasUrgent)

const togglePopover = () => {
  isOpen.value = !isOpen.value
}

const closePopover = () => {
  isOpen.value = false
}

onMounted(() => {
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
  notificationStore.getUnreadCount()
  
  // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  connect()
})

onBeforeUnmount(() => {
  disconnect()
})
</script>

<style scoped>
.notification-bell-container {
  position: relative;
  display: inline-block;
}

.bell-button {
  position: relative;
  width: 44px;
  height: 44px;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 150ms cubic-bezier(0.16, 1, 0.3, 1);
}

.bell-button:hover {
  background: var(--color-secondary);
}

.bell-button.active {
  background: var(--color-secondary);
}

.bell-icon {
  width: 20px;
  height: 20px;
  color: var(--color-text);
  stroke-width: 2;
}

.badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--color-error);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
  border: 2px solid var(--color-background);
  animation: pulse 2s infinite;
}

.urgent-indicator {
  position: absolute;
  top: 0;
  right: 0;
  width: 10px;
  height: 10px;
  background: var(--color-error);
  border-radius: 50%;
  border: 2px solid white;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}
</style>

### 6.4 NotificationPopover Component

<!-- components/Notifications/NotificationPopover.vue -->

<template>
  <div class="notification-popover">
    <!-- Header -->
    <div class="popover-header">
      <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
      <button 
        v-if="unreadCount > 0"
        @click="handleMarkAllRead"
        class="btn-mark-all"
        title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M9 12l2 2 4-4" />
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8" />
        </svg>
      </button>
      <button 
        @click="$emit('close')"
        class="btn-close"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã (–≤–∫–ª–∞–¥–∫–∏) -->
    <div class="popover-tabs">
      <button
        v-for="tab in tabs"
        :key="tab.id"
        @click="notificationStore.setFilter(tab.id as any)"
        :class="['tab', { active: currentFilter === tab.id }]"
      >
        {{ tab.label }}
        <span v-if="tab.count > 0" class="count">{{ tab.count }}</span>
      </button>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="popover-body">
      <template v-if="filteredNotifications.length > 0">
        <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º -->
        <template v-if="groupedByDate.today.length > 0">
          <h4 class="date-header">–°–µ–≥–æ–¥–Ω—è</h4>
          <NotificationCard 
            v-for="notif in groupedByDate.today"
            :key="notif.id"
            :notification="notif"
            @mark-read="handleMarkRead"
            @delete="handleDelete"
          />
        </template>
        
        <template v-if="groupedByDate.yesterday.length > 0">
          <h4 class="date-header">–í—á–µ—Ä–∞</h4>
          <NotificationCard 
            v-for="notif in groupedByDate.yesterday"
            :key="notif.id"
            :notification="notif"
            @mark-read="handleMarkRead"
            @delete="handleDelete"
          />
        </template>
        
        <template v-if="groupedByDate.older.length > 0">
          <h4 class="date-header">–†–∞–Ω–µ–µ</h4>
          <NotificationCard 
            v-for="notif in groupedByDate.older"
            :key="notif.id"
            :notification="notif"
            @mark-read="handleMarkRead"
            @delete="handleDelete"
          />
        </template>
      </template>
      
      <!-- Empty state -->
      <NotificationEmpty v-else />
    </div>
    
    <!-- Footer -->
    <div class="popover-footer">
      <router-link to="/notifications/archive" class="link-view-all">
        –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Üí
      </router-link>
      <button
        @click="showSettings = true"
        class="btn-settings"
        title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="3" />
          <path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m6.08 0l4.24-4.24M1 12h6m6 0h6m-1.78 7.78l-4.24-4.24m-6.08 0l-4.24 4.24" />
        </svg>
      </button>
    </div>
    
    <!-- Settings Modal -->
    <NotificationSettings 
      v-if="showSettings"
      @close="showSettings = false"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useNotificationStore } from '@/stores/notificationStore'
import NotificationCard from './NotificationCard.vue'
import NotificationEmpty from './NotificationEmpty.vue'
import NotificationSettings from './NotificationSettings.vue'

const notificationStore = useNotificationStore()
const showSettings = ref(false)

const currentFilter = computed(() => notificationStore.currentFilter)
const filteredNotifications = computed(() => notificationStore.filteredNotifications)
const groupedByDate = computed(() => notificationStore.groupedByDate)
const unreadCount = computed(() => notificationStore.unreadCount)

const tabs = computed(() => [
  {
    id: 'all',
    label: '–í—Å–µ',
    count: notificationStore.notifications.length
  },
  {
    id: 'unread',
    label: '–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ',
    count: unreadCount.value
  },
  {
    id: 'important',
    label: '–í–∞–∂–Ω—ã–µ',
    count: notificationStore.notifications.filter(n => ['HIGH', 'URGENT'].includes(n.priority)).length
  }
])

const handleMarkRead = (notificationId: number) => {
  notificationStore.markAsRead(notificationId)
}

const handleMarkAllRead = () => {
  notificationStore.markAllAsRead()
}

const handleDelete = (notificationId: number) => {
  notificationStore.deleteNotification(notificationId)
}

onMounted(() => {
  notificationStore.fetchNotifications('SENT')
})
</script>

<style scoped>
.notification-popover {
  position: absolute;
  top: 56px;
  right: 0;
  width: 400px;
  max-width: 90vw;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  max-height: 600px;
  z-index: 1000;
  animation: slideDown 150ms cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.popover-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--color-border);
}

.popover-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.btn-mark-all,
.btn-close,
.btn-settings {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--color-text-secondary);
  transition: all 150ms;
}

.btn-mark-all:hover,
.btn-close:hover,
.btn-settings:hover {
  background: var(--color-secondary);
  color: var(--color-text);
}

.btn-mark-all svg,
.btn-close svg,
.btn-settings svg {
  width: 18px;
  height: 18px;
  stroke-width: 2;
}

.popover-tabs {
  display: flex;
  gap: 4px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--color-border);
}

.tab {
  flex: 1;
  padding: 8px 12px;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  color: var(--color-text-secondary);
  transition: all 150ms;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.tab:hover {
  background: var(--color-secondary);
}

.tab.active {
  color: var(--color-primary);
  background: rgba(33, 128, 141, 0.1);
}

.tab .count {
  font-size: 11px;
  font-weight: 600;
}

.popover-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.date-header {
  padding: 12px 16px 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 0;
}

.popover-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-top: 1px solid var(--color-border);
}

.link-view-all {
  color: var(--color-primary);
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: color 150ms;
}

.link-view-all:hover {
  color: var(--color-primary-hover);
}
</style>

### 6.5 NotificationCard Component

<!-- components/Notifications/NotificationCard.vue -->

<template>
  <div :class="['notification-card', { unread: !isRead, urgent: isUrgent }]">
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –∏–∫–æ–Ω–∫–∞ -->
    <div class="card-left">
      <div v-if="!isRead" class="unread-dot" />
      <img v-if="notification.icon_url" :src="notification.icon_url" :alt="notification.icon_type" class="icon" />
      <div v-else :class="['icon-placeholder', `icon-${notification.icon_type}`]">
        <svg v-if="notification.icon_type === 'success'" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4" stroke="currentColor" fill="none" stroke-width="2" />
        </svg>
        <svg v-else-if="notification.icon_type === 'error'" viewBox="0 0 24 24">
          <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" fill="none" stroke-width="2" />
        </svg>
        <svg v-else-if="notification.icon_type === 'warning'" viewBox="0 0 24 24">
          <path d="M12 9v2m0 4v2m9.16-13.15l-9.45-5.45a1 1 0 0 0-1.42 0l-9.45 5.45a1 1 0 0 0 0 1.73l9.45 5.45a1 1 0 0 0 1.42 0l9.45-5.45a1 1 0 0 0 0-1.73z" stroke="currentColor" fill="none" stroke-width="2" />
        </svg>
      </div>
    </div>
    
    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å: –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
    <div class="card-center">
      <h4 class="title">{{ notification.title }}</h4>
      <p class="message">{{ notification.message }}</p>
      <span class="timestamp">{{ formatTime(notification.created_at) }}</span>
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="card-right">
      <button 
        @click="handleAction(action)"
        v-for="action in notification.actions.slice(0, 1)"
        :key="action.id"
        :class="['action-btn', `btn-${action.type}`, `btn-${action.style}`]"
      >
        {{ action.label }}
      </button>
      
      <!-- –ú–µ–Ω—é -->
      <div class="context-menu">
        <button @click="toggleMenu" class="menu-trigger">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <circle cx="6" cy="12" r="2" />
            <circle cx="12" cy="12" r="2" />
            <circle cx="18" cy="12" r="2" />
          </svg>
        </button>
        
        <div v-if="menuOpen" class="menu-dropdown">
          <button v-if="!isRead" @click="handleMarkRead" class="menu-item">
            ‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
          </button>
          <button @click="handleDelete" class="menu-item delete">
            üóë –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import type { INotification } from '@/stores/notificationStore'

const props = defineProps<{
  notification: INotification
}>()

const emit = defineEmits<{
  'mark-read': [id: number]
  'delete': [id: number]
}>()

const menuOpen = ref(false)

const isRead = computed(() => props.notification.state === 'READ')
const isUrgent = computed(() => props.notification.priority === 'URGENT')

const formatTime = (dateString: string) => {
  const date = new Date(dateString)
  const now = new Date()
  const diffMs = now.getTime() - date.getTime()
  const diffMins = Math.floor(diffMs / 60000)
  const diffHours = Math.floor(diffMins / 60)
  const diffDays = Math.floor(diffHours / 24)
  
  if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'
  if (diffMins < 60) return `${diffMins} –º–∏–Ω. –Ω–∞–∑–∞–¥`
  if (diffHours < 24) return `${diffHours} —á. –Ω–∞–∑–∞–¥`
  if (diffDays < 7) return `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`
  
  return date.toLocaleDateString('ru-RU')
}

const toggleMenu = () => {
  menuOpen.value = !menuOpen.value
}

const handleAction = (action: any) => {
  if (action.type === 'link') {
    window.location.href = action.url
  } else if (action.type === 'button') {
    // Handle button action
    fetch(action.url, { method: 'POST' })
  }
}

const handleMarkRead = () => {
  emit('mark-read', props.notification.id)
  menuOpen.value = false
}

const handleDelete = () => {
  emit('delete', props.notification.id)
  menuOpen.value = false
}
</script>

<style scoped>
.notification-card {
  display: flex;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--color-border);
  background: var(--color-surface);
  cursor: pointer;
  transition: all 150ms;
}

.notification-card:hover {
  background: var(--color-secondary);
}

.notification-card.unread {
  background: rgba(33, 128, 141, 0.05);
}

.notification-card.unread:hover {
  background: rgba(33, 128, 141, 0.1);
}

.notification-card.urgent {
  border-left: 3px solid var(--color-error);
}

.card-left {
  position: relative;
  flex-shrink: 0;
}

.unread-dot {
  position: absolute;
  top: -4px;
  left: -4px;
  width: 8px;
  height: 8px;
  background: var(--color-primary);
  border-radius: 50%;
}

.icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  object-fit: cover;
}

.icon-placeholder {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--color-secondary);
}

.icon-placeholder svg {
  width: 20px;
  height: 20px;
}

.icon-success {
  background: rgba(34, 197, 94, 0.1);
  color: #22c55e;
}

.icon-error {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

.icon-warning {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
}

.card-center {
  flex: 1;
  min-width: 0;
}

.title {
  margin: 0 0 4px;
  font-size: 14px;
  font-weight: 600;
  color: var(--color-text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.message {
  margin: 0 0 4px;
  font-size: 13px;
  color: var(--color-text-secondary);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.timestamp {
  font-size: 11px;
  color: var(--color-text-secondary);
}

.card-right {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  flex-shrink: 0;
}

.action-btn {
  padding: 6px 12px;
  border: 1px solid var(--color-border);
  background: var(--color-surface);
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 150ms;
  white-space: nowrap;
}

.action-btn.btn-link {
  border-color: var(--color-primary);
  color: var(--color-primary);
}

.action-btn.btn-link:hover {
  background: rgba(33, 128, 141, 0.1);
}

.context-menu {
  position: relative;
}

.menu-trigger {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--color-text-secondary);
  transition: all 150ms;
}

.menu-trigger:hover {
  background: var(--color-secondary);
  color: var(--color-text);
}

.menu-trigger svg {
  width: 18px;
  height: 18px;
}

.menu-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  min-width: 160px;
  z-index: 100;
  animation: slideDown 150ms ease-out;
}

.menu-item {
  display: block;
  width: 100%;
  padding: 12px 16px;
  border: none;
  background: transparent;
  text-align: left;
  cursor: pointer;
  font-size: 13px;
  color: var(--color-text);
  transition: all 150ms;
}

.menu-item:hover {
  background: var(--color-secondary);
}

.menu-item.delete:hover {
  background: rgba(239, 68, 68, 0.1);
  color: var(--color-error);
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

### 6.6 WebSocket Hook (useWebSocket.ts)

// hooks/useWebSocket.ts

import { useNotificationStore } from '@/stores/notificationStore'

const WS_URL = import.meta.env.VITE_WS_URL || 'ws://localhost:8000/ws/notifications/'

export function useWebSocket() {
  let websocket: WebSocket | null = null
  const notificationStore = useNotificationStore()
  
  const getToken = () => {
    // Get JWT token from localStorage / vuex / etc
    return localStorage.getItem('auth_token')
  }
  
  const connect = () => {
    const token = getToken()
    if (!token) {
      console.warn('No auth token available for WebSocket')
      return
    }
    
    try {
      websocket = new WebSocket(`${WS_URL}?token=${token}`)
      
      websocket.onopen = () => {
        console.log('WebSocket connected')
        // Send heartbeat periodically
        setInterval(() => {
          if (websocket?.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({
              type: 'ping',
              timestamp: new Date().toISOString()
            }))
          }
        }, 30000)
      }
      
      websocket.onmessage = (event) => {
        const message = JSON.parse(event.data)
        
        switch (message.type) {
          case 'notification.new':
            notificationStore.handleNewNotification(message.data)
            break
          
          case 'notification.read':
            // Handle read status update
            break
          
          case 'pong':
            // Heartbeat response
            break
          
          default:
            console.log('Unknown message type:', message.type)
        }
      }
      
      websocket.onerror = (error) => {
        console.error('WebSocket error:', error)
      }
      
      websocket.onclose = () => {
        console.log('WebSocket disconnected')
        // Try to reconnect after 5 seconds
        setTimeout(connect, 5000)
      }
      
    } catch (error) {
      console.error('Failed to connect WebSocket:', error)
    }
  }
  
  const disconnect = () => {
    if (websocket) {
      websocket.close()
      websocket = null
    }
  }
  
  return {
    connect,
    disconnect
  }
}

### 6.7 API Service (notificationService.ts)

**–í–ê–ñ–ù–û:** –í—Å–µ endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `/api/v4/headless/notifications/`.

```typescript
// services/notificationService.ts

import axios from 'axios'

const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:8000'

const apiClient = axios.create({
  baseURL: `${API_BASE}/api/v4/headless`,
  headers: {
    'Content-Type': 'application/json'
  }
})

// Add auth token to all requests
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('auth_token')
  if (token) {
    config.headers.Authorization = `Token ${token}`  // Mayan –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Token, –Ω–µ Bearer
  }
  return config
})

export const notificationService = {
  // Get notifications
  getNotifications: (params: {
    state?: string
    page?: number
    page_size?: number
    sort_by?: string
    filter_event?: string
  }) => {
    return apiClient.get('/notifications/', { params }).then(r => r.data)
  },
  
  // Get single notification
  getNotification: (id: number) => {
    return apiClient.get(`/notifications/${id}/`).then(r => r.data)
  },
  
  // Mark as read
  markAsRead: (id: number) => {
    return apiClient.patch(`/notifications/${id}/read/`).then(r => r.data)
  },
  
  // Mark all as read
  markAllAsRead: (eventType?: string) => {
    return apiClient.post('/notifications/read-all/', {
      filter_event_type: eventType
    }).then(r => r.data)
  },
  
  // Delete notification
  deleteNotification: (id: number) => {
    return apiClient.delete(`/notifications/${id}/`).then(r => r.data)
  },
  
  // Get unread count
  getUnreadCount: () => {
    return apiClient.get('/notifications/unread-count/').then(r => r.data)
  },
  
  // Get preferences
  getPreferences: () => {
    return apiClient.get('/notifications/preferences/').then(r => r.data)
  },
  
  // Update preferences
  updatePreferences: (preferences: any) => {
    return apiClient.patch('/notifications/preferences/', preferences).then(r => r.data)
  }
}
```

---

## WEBSOCKET / REAL-TIME

### 7.1 WebSocket –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Django Channels)

**–í–ê–ñ–ù–û:** –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Gunicorn (WSGI). –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å Django Channels –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å ASGI.

#### 7.1.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–§–∞–π–ª:** `requirements/base.txt`

```txt
# –î–æ–±–∞–≤–∏—Ç—å:
channels==3.0.5
channels-redis==4.1.0
daphne==4.0.0
```

#### 7.1.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ INSTALLED_APPS

**–§–∞–π–ª:** `mayan/settings/base.py`

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ INSTALLED_APPS (–ø–µ—Ä–µ–¥ 'django.contrib.staticfiles'):
INSTALLED_APPS = [
    # ...
    'daphne',  # ASGI server (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º)
    'channels',
    'mayan.apps.notifications',  # –ù–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    # ...
]

# –î–æ–±–∞–≤–∏—Ç—å ASGI_APPLICATION
ASGI_APPLICATION = 'mayan.asgi.application'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CHANNEL_LAYERS
CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            "hosts": [
                (
                    os.environ.get('MAYAN_REDIS_HOST', 'redis'),
                    int(os.environ.get('MAYAN_REDIS_PORT', 6379))
                )
            ],
            "password": os.environ.get('MAYAN_REDIS_PASSWORD', ''),
            # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è channels (DB 3)
            "prefix": "mayan_channels",
        },
    },
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Redis DB 3 –¥–ª—è channels (DB 0 - cache, DB 1 - Celery, DB 2 - locks).

### 7.2 ASGI –∫–æ–Ω—Ñ–∏–≥ (asgi.py)

**–§–∞–π–ª:** `mayan/asgi.py` (–æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª)

```python
"""
ASGI config for Mayan EDMS project.

It exposes the ASGI callable as a module-level variable named ``application``.
"""

import os
from django.core.asgi import get_asgi_application
from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter
from django.urls import path

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mayan.settings.production')

# –ü–æ–ª—É—á–∏—Ç—å Django ASGI application
django_asgi_app = get_asgi_application()

# –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å consumer —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ channels —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
try:
    from mayan.apps.notifications.consumers import NotificationConsumer
    
    application = ProtocolTypeRouter({
        'http': django_asgi_app,
        'websocket': AuthMiddlewareStack(
            URLRouter([
                path('ws/notifications/', NotificationConsumer.as_asgi()),
            ])
        ),
    })
except ImportError:
    # Fallback –µ—Å–ª–∏ channels –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    application = django_asgi_app
```

#### 7.2.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.yml

**–§–∞–π–ª:** `docker-compose.yml`

```yaml
# –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å app –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Daphne –≤–º–µ—Å—Ç–æ Gunicorn
services:
  app:
    # ...
    environment:
      # ...
      # –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è Daphne (ASGI server)
      MAYAN_ASGI_APPLICATION: 'mayan.asgi.application'
    # ...
    # –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    # command: daphne -b 0.0.0.0 -p 8000 mayan.asgi:application
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í production –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Uvicorn –∏–ª–∏ –¥—Ä—É–≥–æ–π ASGI server –≤–º–µ—Å—Ç–æ Daphne.

---

## –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 8.1 Backend Tests (test_views.py)

# tests/test_views.py

from django.test import TestCase
from django.contrib.auth.models import User
from rest_framework.test import APIClient
from rest_framework import status
from notifications.models import Notification


class NotificationViewSetTests(TestCase):
    def setUp(self):
        self.client = APIClient()
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass'
        )
        self.client.force_authenticate(user=self.user)
    
    def test_get_notifications(self):
        """Test GET /api/v4/notifications/"""
        Notification.objects.create(
            user=self.user,
            title='Test',
            message='Test message',
            event_type='test_event',
            state='SENT'
        )
        
        response = self.client.get('/api/v4/notifications/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data['results']), 1)
    
    def test_mark_as_read(self):
        """Test PATCH /api/v4/notifications/{id}/read/"""
        notif = Notification.objects.create(
            user=self.user,
            title='Test',
            message='Test message',
            event_type='test_event',
            state='SENT'
        )
        
        response = self.client.patch(f'/api/v4/notifications/{notif.id}/read/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['state'], 'READ')
        
        notif.refresh_from_db()
        self.assertEqual(notif.state, 'READ')
        self.assertIsNotNone(notif.read_at)
    
    def test_unread_count(self):
        """Test GET /api/v4/notifications/unread-count/"""
        Notification.objects.create(
            user=self.user,
            title='Test 1',
            message='Message 1',
            event_type='test_event',
            state='SENT'
        )
        Notification.objects.create(
            user=self.user,
            title='Test 2',
            message='Message 2',
            event_type='test_event',
            state='SENT',
            priority='URGENT'
        )
        
        response = self.client.get('/api/v4/notifications/unread-count/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['unread_count'], 2)
        self.assertTrue(response.data['has_urgent'])

### 8.2 Frontend Tests (NotificationBell.spec.ts)

// components/__tests__/NotificationBell.spec.ts

import { describe, it, expect, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import NotificationBell from '../Notifications/NotificationBell.vue'

describe('NotificationBell.vue', () => {
  it('renders bell icon', () => {
    const wrapper = mount(NotificationBell)
    const icon = wrapper.find('.bell-icon')
    expect(icon.exists()).toBe(true)
  })
  
  it('shows badge with unread count', () => {
    const wrapper = mount(NotificationBell)
    // Mock store
    // wrapper.vm.$store.state.notifications.unreadCount = 5
    // Expect badge to show '5'
  })
  
  it('toggles popover on click', async () => {
    const wrapper = mount(NotificationBell)
    const button = wrapper.find('.bell-button')
    
    expect(wrapper.vm.isOpen).toBe(false)
    await button.trigger('click')
    expect(wrapper.vm.isOpen).toBe(true)
  })
})

---

## TIMELINE –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –ù–µ–¥–µ–ª—è 1: Database + Models
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è events_notification
- [ ] –°–æ–∑–¥–∞—Ç—å data migration –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ (NotificationPreference, NotificationTemplate, NotificationLog)
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å Notification –≤ events/models.py
- [ ] –°–æ–∑–¥–∞—Ç—å Django Admin –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit tests –¥–ª—è –º–æ–¥–µ–ª–µ–π

### –ù–µ–¥–µ–ª—è 2: Backend API
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ViewSets –∏ Serializers –≤ headless_api
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API endpoints –≤ headless_api/urls.py
- [ ] –î–æ–±–∞–≤–∏—Ç—å permissions + authentication
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å tests –¥–ª—è API
- [ ] Swagger documentation
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º endpoint /api/v4/events/notifications/

### –ù–µ–¥–µ–ª—è 3: Celery + EventType Integration
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å EventType.commit() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É create_enhanced_notification()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Celery tasks (–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º, cleanup)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å email templates
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ async –∑–∞–¥–∞—á
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (EventSubscription)

### –ù–µ–¥–µ–ª—è 4: WebSocket + Channels
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å channels, channels-redis, daphne –≤ requirements/base.txt
- [ ] –û–±–Ω–æ–≤–∏—Ç—å mayan/settings/base.py (INSTALLED_APPS, CHANNEL_LAYERS)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å mayan/asgi.py –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebSocket
- [ ] –û–±–Ω–æ–≤–∏—Ç—å docker-compose.yml –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Daphne/Uvicorn
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WebSocket consumer –≤ notifications/consumers.py
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å real-time –¥–æ—Å—Ç–∞–≤–∫—É
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket

### –ù–µ–¥–µ–ª—è 5: Frontend Components
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Pinia store
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å NotificationBell –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å NotificationPopover –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å NotificationCard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏ –∞–Ω–∏–º–∞—Ü–∏–∏

### –ù–µ–¥–µ–ª—è 6: Integration + Polish
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–∞ + –±—ç–∫–∞
- [ ] WebSocket —Ö—É–∫ –∏ real-time updates
- [ ] –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ E2E
- [ ] Performance optimization
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## –ß–ï–ö–õ–ò–°–¢ –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ê

### –ë—ç–∫–µ–Ω–¥ (Django)

**Database:**
- [ ] Migration —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (EXPLAIN ANALYZE)
- [ ] Constraints –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

**Models:**
- [ ] –í—Å–µ –ø–æ–ª—è –∏ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Manager –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°–∏–≥–Ω–∞–ª—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**API:**
- [ ] –í—Å–µ endpoints —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Pagination —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Filtering + searching —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Permissions –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- [ ] Error handling —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] Swagger docs –∞–∫—Ç—É–∞–ª—å–Ω—ã

**Signals + Tasks:**
- [ ] Celery tasks —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- [ ] Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Cleanup –∑–∞–¥–∞—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- [ ] Retry logic —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

**WebSocket:**
- [ ] Channels configured
- [ ] Consumer –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è/–æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- [ ] Heartbeat —Ä–∞–±–æ—Ç–∞–µ—Ç

**Tests:**
- [ ] –í—Å–µ views –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Models –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Serializers –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Coverage > 80%

### –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Vue 3)

**Store (Pinia):**
- [ ] State –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] Actions –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Computed properties —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Error handling —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**Components:**
- [ ] NotificationBell —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è
- [ ] NotificationPopover –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- [ ] NotificationCard –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] Filter tabs —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Actions (–∫–Ω–æ–ø–∫–∏) —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç

**Styling:**
- [ ] Design system colors –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- [ ] Responsive design —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–ª–∞–≤–Ω—ã–µ
- [ ] Dark mode –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

**Integration:**
- [ ] API calls —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- [ ] Real-time updates –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- [ ] Error states –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã

**Tests:**
- [ ] Components –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Store –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Integration —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## –ü–†–ò–õ–û–ñ–ï–ù–ò–ï: –°–¶–ï–ù–ê–†–ò–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã (Happy Path)

1. **Backend:** –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Üí `event_document_file_created.commit()` ‚Üí EventType.commit() —Å–æ–∑–¥–∞–µ—Ç Action
2. **Backend:** EventType.commit() –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —á–µ—Ä–µ–∑ EventSubscription ‚Üí —Å–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤–æ–µ Notification
3. **Backend:** create_enhanced_notification() —Ä–∞—Å—à–∏—Ä—è–µ—Ç Notification (title, message, priority, actions)
4. **Backend:** Celery task `send_notification_async()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:
   - Email (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
   - WebSocket push
3. **Frontend (WebSocket):** –ü–æ–ª—É—á–∞–µ—Ç `notification.new` ‚Üí Pinia store –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
4. **Frontend (UI):** 
   - –ë–µ–π–¥–∂ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
   - Popover –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. **User:** –ö–ª–∏–∫–∞–µ—Ç –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Admin –≤–∏–¥–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É

1. **Backend:** –í—ã—è–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (—Å–±–æ–π S3)
2. **Signal:** –°–æ–∑–¥–∞–µ—Ç—Å—è Notification —Å priority='URGENT'
3. **Celery:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Email + WebSocket
4. **Frontend:**
   - –ö—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ (urgent indicator)
   - Popover –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–æ –∫—Ä–∞—Å–Ω—ã–º
5. **Admin:** –í–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É" ‚Üí –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

1. **Frontend:** User –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç NotificationSettings
2. **User:** –û—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è "comment_added"
3. **Frontend:** POST /api/v4/events/event_types/{id}/unsubscribe/ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint Mayan)
4. **Backend:** –£–¥–∞–ª—è–µ—Ç EventSubscription –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
5. **Celery:** –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ EventType.commit())

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (email, quiet hours) —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑:
- PATCH /api/v4/headless/notifications/preferences/

---

---

## –ü–†–ò–õ–û–ñ–ï–ù–ò–ï: –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –û–¢ –í–ï–†–°–ò–ò 1.0

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ä—Å–∏–∏ 1.1 (24.12.2025)

1. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–æ–¥–µ–ª–∏ Notification:**
   - –í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã, —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è `events_notification`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏ (`user`, `action`, `read`)
   - –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ ALTER TABLE –º–∏–≥—Ä–∞—Ü–∏—é

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EventType.commit():**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ `EventType.commit()`
   - –†–∞—Å—à–∏—Ä–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å title, message, priority, actions
   - –ù–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ signal handlers –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è

3. **API endpoints –≤ headless_api:**
   - –í—Å–µ –Ω–æ–≤—ã–µ endpoints —Å–æ–∑–¥–∞–Ω—ã –≤ `headless_api`: `/api/v4/headless/notifications/`
   - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint `/api/v4/events/notifications/` —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫:**
   - –ü–æ–¥–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `EventSubscription` –∏ `ObjectEventSubscription` (Mayan EDMS)
   - `NotificationPreference` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (email, quiet hours)
   - –ü–æ–ª–µ `subscriptions` —É–¥–∞–ª–µ–Ω–æ –∏–∑ `NotificationPreference`

5. **Data Migration:**
   - –°–æ–∑–¥–∞–Ω–∞ data migration –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `NotificationTemplate` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ title/message –∏–∑ Action

6. **Django Channels:**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Django Channels
   - –û–±–Ω–æ–≤–ª–µ–Ω `mayan/asgi.py` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebSocket
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é docker-compose.yml

---

**–î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É.**

**–î–∞—Ç–∞:** 24.12.2025  
**–í–µ—Ä—Å–∏—è:** 1.1  
**–°—Ç–∞—Ç—É—Å:** APPROVED FOR DEVELOPMENT
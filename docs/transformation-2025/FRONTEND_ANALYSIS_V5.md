# –ê–Ω–∞–ª–∏–∑ –§—Ä–æ–Ω—Ç–µ–Ω–¥–∞ V5 ‚Äî Vue 3 / Vite (–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 08 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 5.0 (–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é –∫–æ–¥–∞)  
**–ê–≤—Ç–æ—Ä:** Lead Software Architect  
**–°—Ç–∞—Ç—É—Å:** üü° –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ Headless API –¥–ª—è self-service —Ñ—É–Ω–∫—Ü–∏–π

---

## 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ API —Å–ª–æ–π (apiService.ts)

- **Axios –∏–Ω—Å—Ç–∞–Ω—Å:** `baseURL = VITE_API_URL`, `withCredentials: true`, timeout 30s.
- **Request interceptor:** –¥–æ–±–∞–≤–ª—è–µ—Ç `Authorization: Token <token>` (–±–µ—Ä—ë—Ç –∏–∑ `authService.getToken()`), –¥–æ–±–∞–≤–ª—è–µ—Ç CSRF (`X-CSRFToken`) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏, –ª–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ DEV.
- **Response interceptor:**
  - 401 ‚Üí `clearToken()` + —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login`.
  - 403 ‚Üí –±—Ä–æ—Å–∞–µ—Ç `ApiError { code: 'FORBIDDEN' }`.
  - 404 –¥–ª—è `/headless/` ‚Üí `ApiError { code: 'HEADLESS_NOT_AVAILABLE' }`.
  - –†–µ—Ç—Ä–∞–∏ –Ω–∞ —Å–µ—Ç–µ–≤—ã—Ö/5xx –¥–æ 3 —Ä–∞–∑ (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞).
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET —á–µ—Ä–µ–∑ `cacheService`.
- **–§–∞–∫—Ç:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DRF Token + Session, JWT/Knox –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.

---

## 2. –°–µ—Ä–≤–∏—Å—ã, –∑–∞–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞ Headless / REST

- **editorService.ts**
  - `saveEditedImage(documentId, blob, {format?, comment?})` ‚Üí `POST /api/v4/headless/documents/{id}/versions/new_from_edit/` (multipart, file + optional format/comment).
  - `createAssetFromImage(documentTypeId, blob, filename, {format?, comment?})`:
    1) `POST /api/v4/documents/` —Å `document_type_id`, label/description.
    2) `POST /api/v4/documents/{id}/files/` multipart (action=1).
  - **–°—Ç–∞—Ç—É—Å:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥ –µ—Å—Ç—å, –Ω–æ –±—ç–∫–µ–Ω–¥-–º–∞—Ä—à—Ä—É—Ç —Å–µ–π—á–∞—Å **–Ω–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω** –≤ `mayan/apps/rest_api/urls.py`, –ø–æ—ç—Ç–æ–º—É –ø–æ–ª—É—á–∞–µ—Ç 404 –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞.

- **activityService.ts**
  - –†–µ–∞–ª—å–Ω–æ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `GET /api/v4/headless/dashboard/activity/?limit=` (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞).
  - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è feed (`/headless/activity/feed/` —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏) –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–µ—Ä–≤–∏—Å–µ –∏ UI ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å.

- **authService.ts**
  - `obtainToken` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `application/x-www-form-urlencoded` –Ω–∞ `/api/v4/auth/token/obtain/`, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ localStorage.
  - `changePassword` –±—å—ë—Ç –≤ `/api/v4/headless/password/change/`, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `VITE_BFF_ENABLED=true` (–∏–Ω–∞—á–µ –±—Ä–æ—Å–∞–µ—Ç –æ—à–∏–±–∫—É).
  - `getCurrentUser` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/api/v4/users/current/` —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ localStorage.

- **documentTypeService.ts**
  - –°—É—â–µ—Å—Ç–≤—É–µ—Ç; —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `VITE_BFF_ENABLED=true` (–∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ –∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç).
  - `getAllDocumentTypes`, `getDocumentTypeConfig`, `validateMetadata` –¥–ª—è required –ø–æ–ª–µ–π.

- **uploadService.ts**
  - –°—Ç—Ä–∞—Ç–µ–≥–∏—è simple/chunked; –ø—Ä–∏ `VITE_BFF_ENABLED=true` –¥–µ–ª–∞–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `documentTypeService.validateMetadata`.
  - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `document_type_id` = 1, –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥—Ä—É–≥–æ–π; metadata –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞.

---

## 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### AssetDetailPage.vue

- **–ö–Ω–æ–ø–∫–∞ ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª:** `v-if="isImage"` ‚Äî –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ª—é–±—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–µ—Ç.
- **–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:** `showPreview` —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ; —Ñ–∞–≤–æ—Ä–∏—Ç—ã —á–µ—Ä–µ–∑ `toggleFavorite`.
- **–û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:** `showMediaEditor = true` ‚Üí `<MediaEditorModal :asset="asset" :is-open="showMediaEditor" @saveVersion ... />`.

### MediaEditorModal.vue

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π blob-URL: `URL.createObjectURL`, `img.crossOrigin='anonymous'`, —Ä–∏—Å—É–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ blob —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å **tainted canvas** (—Ñ–∏–∫—Å –ø—Ä–∏–º–µ–Ω—ë–Ω).
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
  - –°–æ–±–∏—Ä–∞–µ—Ç canvas ‚Üí `canvas.toBlob` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `saveEditedImage` (headless new_from_edit).
  - –ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ —ç–º–∏—Ç–∏—Ç `saveVersion` –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É.
- Cropper/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: state –≤ `editorStore` (undo/redo, crop, watermark, resize, DPI).
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `createAssetFromImage` (–≤ —Å–µ—Ä–≤–∏—Å–µ) –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ –∫–æ–ø–∏–∏.

### Auth –∏ Stores

- `authStore`: —Ç–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage (`auth_token`), —á–∏—Ç–∞–µ—Ç—Å—è `apiService`; 401 –æ—á–∏—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç. –õ–æ–≥–∏–Ω = `authService.obtainToken` (form-urlencoded), –ø–æ—Ç–æ–º `getCurrentUser`.
- –ö–æ–ª–ª–µ–∫—Ü–∏–∏/–≥–∞–ª–µ—Ä–µ—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ REST (`/api/v4/documents/optimized/` –∏ —Ç.–ø.).
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (Users/Groups/Schemas/Workflows) —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `/api/v4/...` —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π/–ø–æ–∏—Å–∫–æ–º.

---

## 4. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑—Ä—ã–≤—ã (—á—Ç–æ –æ–±–µ—â–∞–Ω–æ, –Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ)

| –§—É–Ω–∫—Ü–∏—è | –ö–æ–¥ —Å–µ–π—á–∞—Å | –ß—Ç–æ –Ω—É–∂–Ω–æ |
|---------|------------|-----------|
| –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è | `authService.changePassword` —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ `VITE_BFF_ENABLED=true`**; –∏–Ω–∞—á–µ –Ω–µ—Ç –≤—ã–∑–æ–≤–∞ | –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ BFF –∏–ª–∏ fallback; –ø–æ–∫—Ä—ã—Ç—å UI/–æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ |
| –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è) | –í —Å–µ—Ä–≤–∏—Å–µ —Ç–æ–ª—å–∫–æ dashboard endpoint (`/headless/dashboard/activity/`), feed –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –î–æ–±–∞–≤–∏—Ç—å `/api/v4/headless/activity/feed/` —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ | `documentTypeService` –µ—Å—Ç—å, –Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω –ø—Ä–∏ `VITE_BFF_ENABLED=false`; upload –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç | –í–∫–ª—é—á–∏—Ç—å BFF, —Å–¥–µ–ª–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é metadata –ø–µ—Ä–µ–¥ upload |
| Favorites/My Uploads | Backend –≥–æ—Ç–æ–≤; —Ñ—Ä–æ–Ω—Ç –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ headless (`/headless/favorites/`, `/headless/documents/my_uploads/`) | –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–∑–æ–≤—ã –∏ UI; –¥–æ–±–∞–≤–∏—Ç—å fallback/–æ–±—Ä–∞–±–æ—Ç–∫—É 401/403 |
| new_from_edit –º–∞—Ä—à—Ä—É—Ç | –§—Ä–æ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `/api/v4/headless/documents/{id}/versions/new_from_edit/`, –Ω–æ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –≤ `rest_api/urls.py` | –ü—Ä–æ–±—Ä–æ—Å–∏—Ç—å endpoint –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–∑–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–≥–∞—Ç—å 404 |

---

## 5. –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã / –±–∞–≥–∏

- **–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è** ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `VITE_BFF_ENABLED`; –±–µ–∑ –Ω–µ–≥–æ UI –Ω–µ –≤—ã–∑–æ–≤–µ—Ç headless endpoint.
- **Activity feed (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è)** ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–µ—Ä–≤–∏—Å–µ/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö, –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ dashboard feed.
- **Metadata validation** ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∞, –µ—Å–ª–∏ BFF –≤—ã–∫–ª—é—á–µ–Ω; –≤–æ–∑–º–æ–∂–Ω—ã 400 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.
- **Permissions –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞** ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ mime-type, –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ ACL; 403 –≤–æ–∑–º–æ–∂–µ–Ω –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏.

---

## 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è V5

1) **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ headless:**
   - –û–±–µ—Å–ø–µ—á–∏—Ç—å `VITE_BFF_ENABLED=true` –¥–ª—è prod/stage; –≤–∫–ª—é—á–∏—Ç—å `authService.changePassword`, `documentTypeService`, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `uploadService`.
   - –î–æ–±–∞–≤–∏—Ç—å `activityService.getActivityFeed` ‚Üí `/api/v4/headless/activity/feed/` (filter/pagination) –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤ UI.
   - –ü—Ä–æ–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –º–∞—Ä—à—Ä—É—Ç `new_from_edit` (headless) –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å fallback –≤ UI, –ø–æ–∫–∞ 404 –Ω–µ —É—Å—Ç—Ä–∞–Ω—ë–Ω.

2) **–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å UI/ACL:**
   - –í `AssetDetailPage` —Å–∫—Ä—ã–≤–∞—Ç—å/–¥–∏–∑–µ–π–±–ª–∏—Ç—å ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–∞–≤; –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å 403 –æ—Ç headless/new_from_edit.

3) **E2E —Å–º–æ–∫–∏:**
   - `GET /api/v4/headless/activity/feed/` (200/401).
   - `POST /api/v4/headless/password/change/` (200/400) –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º BFF.
   - `POST /api/v4/headless/documents/{id}/versions/new_from_edit/` —Å —Ç–µ—Å—Ç–æ–≤—ã–º —Ñ–∞–π–ª–æ–º (201/200).

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 5.0 (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥)  
**–î–∞—Ç–∞:** 08 –¥–µ–∫–∞–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** Lead Software Architect

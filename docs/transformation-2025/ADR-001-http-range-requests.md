# ADR-001: Поддержка HTTP Range Requests для скачивания больших файлов

## Статус

Accepted

## Контекст

В Enterprise DAM пользователи скачивают большие файлы (RAW/TIFF/видео) и ожидают:

- Возобновление прерванной загрузки (resume) без скачивания заново.
- Seek / перемотку для видео и аудио (медиа-плееры используют `Range`).
- Предсказуемое поведение в условиях нестабильных сетей и прокси.

Текущий endpoint скачивания `GET /api/v4/documents/{id}/files/{file_id}/download/` отдает файл через `FileResponse`, но не обрабатывает заголовок `Range` и не возвращает необходимые заголовки (`Accept-Ranges`, `Content-Range`).

## Решение

Внедрить поддержку HTTP Range Requests (RFC 7233) на уровне backend:

1. **Django-level Range**: расширить `DownloadViewMixin` для обработки заголовка `Range` и ответа `206 Partial Content` (для single-range).
2. **S3 optimization (опционально)**: добавить режим `?direct=1`, который возвращает redirect на storage URL (например, presigned URL). Это позволяет storage/CDN отдавать Range нативно. По умолчанию поведение остается same-origin (proxy через Django) для совместимости со SPA/XHR и CORS-ограничениями.

## Последствия

### Позитивные

- Resume downloads для больших файлов.
- Seek для видео/аудио (браузеры и плееры смогут запрашивать фрагменты).
- Снижение повторных скачиваний и нагрузки при обрывах соединения.

### Негативные / риски

- Нужно тщательно тестировать корректность парсинга `Range` и статусов (206/416).
- Для режима `?direct=1` возможны CORS-ограничения (SPA/XHR). Поэтому режим является опциональным.

## Примечания по реализации

- Поддерживается только **один диапазон** (single-range). Multipart ranges (`bytes=0-1,4-5`) не поддерживаются.
- Для некорректного диапазона возвращается `416 Range Not Satisfiable` и `Content-Range: bytes */{size}`.

